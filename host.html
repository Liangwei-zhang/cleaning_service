<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FAFBFF">
    <title>ğŸ  æˆ¿æ±æ§åˆ¶å° - çŸ­ç§Ÿæ¸…æ½”ç³»çµ±</title>
    <style>
        /* ========================================
           2026 Flagship Unified Design System
           ======================================== */
        @layer base, components, utilities;

        :root {
            /* æ ¸å¿ƒèª¿è‰²æ¿ - OKLCH é«˜é€šé€æ„Ÿ */
            --primary: oklch(60% 0.2 250);
            --primary-light: oklch(92% 0.04 250);
            --bg-main: oklch(98.5% 0.01 240);
            --surface: oklch(100% 0 0 / 92%);
            --midnight: oklch(25% 0.02 240);
            --text-muted: oklch(55% 0.02 240);
            
            /* ç‰©ç†ç³»çµ±åƒæ•¸ */
            --radius-xl: 32px;
            --radius-lg: 24px;
            --radius-md: 16px;
            --shadow-premium: 0 20px 40px -12px oklch(0% 0 0 / 8%);
            --shadow-fab: 0 12px 28px -6px oklch(60% 0.2 250 / 35%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            background: var(--bg-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: var(--midnight);
            line-height: 1.5;
            padding-bottom: 120px; /* ç‚ºå°èˆªç•™ç©º */
            -webkit-font-smoothing: antialiased;
        }

        /* --- é ‚éƒ¨ç»ç’ƒæ„Ÿå°èˆª --- */
        header {
            position: sticky; top: 0; z-index: 1000;
            background: oklch(100% 0 0 / 75%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 18px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid oklch(0% 0 0 / 5%);
        }
        header h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
        
        .logout-btn {
            padding: 8px 16px; border-radius: 50px; 
            border: 1px solid oklch(0% 0 0 / 8%);
            background: white; font-size: 13px; font-weight: 700;
            transition: 0.2s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .logout-btn:active { transform: scale(0.92); opacity: 0.8; }

        /* --- ä¸»å®¹å™¨èˆ‡é é¢å‹•ç•« --- */
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .page { animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }

        .page-title { font-size: 26px; font-weight: 850; margin-bottom: 24px; letter-spacing: -1px; }

        /* --- å¡ç‰‡é«”ç³» --- */
        .card {
            background: white; border-radius: var(--radius-lg); padding: 22px;
            margin-bottom: 18px; box-shadow: var(--shadow-premium);
            border: 1px solid oklch(100% 0 0 / 10%);
            transition: transform 0.4s cubic-bezier(0.2, 1, 0.3, 1);
            position: relative; overflow: hidden;
        }
        .card:active { transform: scale(0.985); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .card-title { font-size: 18px; font-weight: 800; color: var(--midnight); flex: 1; }
        
        .price-display { font-size: 22px; font-weight: 850; color: var(--midnight); }
        .price-display::before { content: '$'; font-size: 14px; margin-right: 2px; color: var(--text-muted); }

        .info-row { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-muted); margin-top: 6px; }
        
        /* --- ç‹€æ…‹æ¨™ç±¤ --- */
        .badge {
            padding: 4px 12px; border-radius: 10px; font-size: 11px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .status-open { background: oklch(96% 0.1 85); color: oklch(50% 0.15 45); }
        .status-accepted { background: oklch(93% 0.08 240); color: oklch(55% 0.15 250); }
        .status-completed { background: oklch(94% 0.08 160); color: oklch(50% 0.15 155); }

        .property-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
        .meta-tag {
            background: var(--bg-main); padding: 5px 10px; border-radius: 10px;
            font-size: 12px; font-weight: 600; color: oklch(40% 0.02 240);
        }

        /* --- æŒ‰éˆ•çµ„ --- */
        .action-row { display: flex; gap: 10px; margin-top: 20px; padding-top: 16px; border-top: 1px solid oklch(0% 0 0 / 5%); }
        .btn-mini {
            flex: 1; padding: 12px; border-radius: 14px; border: none;
            font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-edit { background: var(--primary-light); color: var(--primary); }
        .btn-del { background: #FFF1F2; color: #E11D48; }
        .btn-mini:active { transform: scale(0.94); }

        /* --- åº•éƒ¨æ‡¸æµ®å°èˆª --- */
        .bottom-nav {
            position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%);
            background: oklch(25% 0.02 240 / 88%); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 8px; border-radius: 50px;
            display: flex; gap: 4px; box-shadow: 0 20px 48px oklch(0% 0 0 / 25%); 
            z-index: 1000; width: fit-content;
        }
        .nav-item {
            padding: 12px 28px; border-radius: 40px; color: white; opacity: 0.5;
            font-size: 15px; font-weight: 700; border: none; background: none; transition: 0.3s;
        }
        .nav-item.active { background: white; color: var(--midnight); opacity: 1; }

        /* --- ç‰©ç†æŒ‰å£“ FAB --- */
        .fab {
            position: fixed; bottom: 105px; right: 24px;
            width: 64px; height: 64px; border-radius: 22px;
            background: var(--midnight); color: white; border: none;
            font-size: 32px; box-shadow: var(--shadow-fab);
            display: flex; align-items: center; justify-content: center; z-index: 900;
            transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .fab:active { transform: scale(0.85) rotate(90deg); }

        /* --- æ¨¡æ…‹æ¡† Premium --- */
        .modal {
            position: fixed; inset: 0; background: oklch(0% 0 0 / 30%);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: none; align-items: flex-end; justify-content: center; 
            z-index: 2000; opacity: 0; transition: 0.3s;
        }
        .modal.active { display: flex; opacity: 1; }
        
        .modal-content {
            background: white; border-radius: 32px 32px 0 0; padding: 32px 24px 48px;
            width: 100%; max-width: 500px; transform: translateY(100%);
            transition: 0.4s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .modal.active .modal-content { transform: translateY(0); }

        /* --- è¡¨å–® --- */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: var(--text-muted); margin-left: 4px; }
        .input-premium {
            width: 100%; padding: 16px; background: var(--bg-main);
            border: 2px solid transparent; border-radius: var(--radius-md);
            font-size: 16px; font-weight: 600; transition: 0.3s;
        }
        .input-premium:focus { background: white; border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px var(--primary-light); }

        .btn-submit {
            background: var(--midnight); color: white; width: 100%;
            padding: 18px; border-radius: 50px; font-weight: 700; font-size: 16px;
            border: none; cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .btn-submit:active { transform: scale(0.96); }

        .toast {
            position: fixed; bottom: 120px; left: 50%; transform: translate(-50%, 40px);
            background: var(--midnight); color: white; padding: 14px 28px;
            border-radius: 50px; font-size: 14px; font-weight: 700; 
            opacity: 0; transition: 0.4s cubic-bezier(0.2, 1, 0.3, 1); z-index: 3000;
        }
        .toast.show { opacity: 1; transform: translate(-50%, 0); }
    </style>
</head>
<body>

    <header>
        <h1>ç‰©ä¸šç®¡ç†</h1>
        <button class="logout-btn" onclick="logout()">ç™»å‡ºç³»ç»Ÿ</button>
    </header>

    <div class="container">
        <main id="pageOrders" class="page">
            <h2 class="page-title">ç•¶å‰è¨‚å–®</h2>
            <div id="hostOrdersList"></div>
        </main>

        <main id="pageProperties" class="page" style="display:none">
            <h2 class="page-title">æˆ¿æºç®¡ç†</h2>
            <div id="myPropertiesList"></div>
        </main>
    </div>

    <button class="fab" id="mainFab" onclick="handleFabClick()">+</button>

    <nav class="bottom-nav">
        <button class="nav-item active" id="btnNavOrders" onclick="switchPage('orders')">ğŸ“‹<br>è¨‚å–®</button>
        <button class="nav-item" id="btnNavProperties" onclick="switchPage('properties')">ğŸ¡<br>æˆ¿æº</button>
    </nav>

    <div class="modal" id="globalModal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom:28px; text-align:center; font-size:22px; font-weight:850;"></h2>
            <div id="modalBody"></div>
            <button class="btn-submit" id="modalSubmit" onclick="submitProperty()">ç¢ºèªæäº¤</button>
            <button style="width:100%; background:none; border:none; color:var(--text-muted); font-weight:700; margin-top:16px; cursor:pointer;" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API = 'https://biggish-londyn-unconvolute.ngrok-free.dev/api';
        const hostPhone = localStorage.getItem('host_phone');
        let currentPage = 'orders';

        if (!hostPhone) { location.href = 'index.html'; }
        function logout() { localStorage.clear(); location.href = 'index.html'; }

        function haptic() { if (navigator.vibrate) navigator.vibrate(20); }

        function switchPage(page) {
            haptic();
            currentPage = page;
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(`page${page.charAt(0).toUpperCase() + page.slice(1)}`).style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`btnNav${page.charAt(0).toUpperCase() + page.slice(1)}`).classList.add('active');
            
            page === 'orders' ? loadOrders() : loadProperties();
        }

        async function loadOrders() {
            try {
                const res = await fetch(`${API}/orders`);
                const data = await res.json();
                const orders = (data.data || []).filter(o => o.host_phone === hostPhone);
                
                document.getElementById('hostOrdersList').innerHTML = orders.map(o => `
                    <div class="card">
                        <div class="card-header">
                            <span class="badge status-${o.status}">${translateStatus(o.status)}</span>
                            <div class="price-display">${o.price}</div>
                        </div>
                        <div class="card-title">${o.property_name || 'æœªå‘½åæˆ¿æº'}</div>
                        <div class="info-row">ğŸ“ ${o.property_address || 'ç„¡åœ°å€è³‡è¨Š'}</div>
                        <div class="info-row">ğŸ• é€€æˆ¿æ™‚é–“: ${o.checkout_time}</div>
                        ${o.status === 'open' ? `
                            <div class="action-row">
                                <button class="btn-mini btn-edit" onclick="editOrder(${o.id})">âœï¸ ç·¨è¼¯</button>
                                <button class="btn-mini btn-del" onclick="deleteOrder(${o.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('') || '<div style="text-align:center; padding:60px; color:gray; font-weight:600;">â˜• æš«ç„¡è¨‚å–®ï¼Œé»æ“Š + è™Ÿç™¼å¸ƒ</div>';
            } catch(e) { showToast('åŠ è¼‰å¤±æ•—'); }
        }

        async function loadProperties() {
            try {
                const res = await fetch(API + '/properties');
                const data = await res.json();
                // åªé¡¯ç¤ºç•¶å‰ç”¨æˆ¶çš„æˆ¿æº
                const properties = (data.data || []).filter(p => p.host_phone === hostPhone);
                
                if (properties.length === 0) {
                    document.getElementById('myPropertiesList').innerHTML = '<div class="empty-state">å°šæœªæ·»åŠ æˆ¿æº<br>é»æ“Šä¸‹æ–¹+æŒ‰éˆ•æ·»åŠ </div>';
                    return;
                }
                
                document.getElementById('myPropertiesList').innerHTML = properties.map(p => `
                    <div class="card">
                        <div class="card-title">${p.name}</div>
                        <div class="info-row">ğŸ“ ${p.address}</div>
                        <div class="property-meta">
                            <span class="meta-tag">ğŸ›ï¸ ${p.bedrooms || 0} è‡¥å®¤</span>
                            <span class="meta-tag">ğŸš¿ ${p.bathrooms || 0} è¡›æµ´</span>
                            <span class="meta-tag">ğŸ“ ${p.area || 0} sqft</span>
                        </div>
                        <div class="action-row">
                            <button class="btn-mini btn-edit" onclick="editProperty(${p.id})">âœï¸ ä¿®æ”¹è³‡è¨Š</button>
                            <button class="btn-mini btn-del" onclick="deleteProperty(${p.id})">ğŸ—‘ï¸ ç§»é™¤</button>
                        </div>
                    </div>
                `).join('') || '<div style="text-align:center; padding:60px; color:gray; font-weight:600;">ğŸ¡ é»æ“Š + è™Ÿæ–°å¢æ‚¨çš„æˆ¿æº</div>';
            } catch(e) { showToast('åŠ è¼‰æˆ¿æºå¤±æ•—'); }
        }

        async function deleteProperty(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æˆ¿æºå—ï¼Ÿ')) return;
            try {
                const res = await fetch(API + '/properties/' + id, { method: 'DELETE' });
                if (res.ok) {
                    showToast('æˆ¿æºå·²åˆªé™¤');
                    loadProperties();
                } else {
                    showToast('åˆªé™¤å¤±æ•—');
                }
            } catch(e) { showToast('åˆªé™¤å¤±æ•—'); }
        }

        async function editProperty(id) {
            try {
                const res = await fetch(API + '/properties/' + id);
                const data = await res.json();
                const p = data.data;
                if (!p) { showToast('æˆ¿æºä¸å­˜åœ¨'); return; }
                
                document.getElementById('modalTitle').textContent = "ä¿®æ”¹æˆ¿æºè³‡è¨Š";
                document.getElementById('modalBody').innerHTML = `
                    <div class="form-group">
                        <label class="form-label">æˆ¿æºåç¨±</label>
                        <input type="text" class="input-premium" id="propName" value="${p.name || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å®Œæ•´åœ°å€</label>
                        <div style="display:flex; gap:8px;">
                            <input type="text" class="input-premium" id="propAddr" value="${p.address || ''}" style="flex:1;">
                            <button type="button" onclick="verifyAddress()" style="padding:0 16px; border-radius:16px; border:none; background:var(--primary); color:white; font-weight:700; white-space:nowrap;">é©—è­‰</button>
                        </div>
                        <div id="addrStatus" style="font-size:12px; margin-top:6px; font-weight:600;"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
                        <div class="form-group">
                            <label class="form-label">çœ/å·</label>
                            <input type="text" class="input-premium" id="propProvince" value="${p.province || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¸‚/å€</label>
                            <input type="text" class="input-premium" id="propCity" value="${p.city || ''}">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:12px">
                        <div class="form-group">
                            <label class="form-label">è¡—é“</label>
                            <input type="text" class="input-premium" id="propStreet" value="${p.street || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é–€ç‰Œ</label>
                            <input type="text" class="input-premium" id="propHouseNum" value="${p.house_number || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">éƒµéå€è™Ÿ</label>
                        <input type="text" class="input-premium" id="propPostal" value="${p.postal_code || ''}">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px">
                        <div class="form-group">
                            <label class="form-label">è‡¥å®¤</label>
                            <input type="number" class="input-premium" id="propBed" value="${p.bedrooms || 1}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¡›æµ´</label>
                            <input type="number" class="input-premium" id="propBath" value="${p.bathrooms || 1}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¨“å±¤</label>
                            <input type="number" class="input-premium" id="propFloor" value="${p.floor || 1}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¢ç© (sqft)</label>
                        <input type="number" class="input-premium" id="propArea" value="${p.area || 800}">
                    </div>
                `;
                
                document.getElementById('modalSubmit').onclick = async () => {
                    const body = {
                        name: document.getElementById('propName').value.trim(),
                        address: document.getElementById('propAddr').value.trim(),
                        province: document.getElementById('propProvince').value.trim(),
                        city: document.getElementById('propCity').value.trim(),
                        street: document.getElementById('propStreet').value.trim(),
                        house_number: document.getElementById('propHouseNum').value.trim(),
                        postal_code: document.getElementById('propPostal').value.trim(),
                        bedrooms: parseInt(document.getElementById('propBed').value) || 1,
                        bathrooms: parseInt(document.getElementById('propBath').value) || 1,
                        floor: parseInt(document.getElementById('propFloor').value) || 1,
                        area: parseInt(document.getElementById('propArea').value) || 800
                    };
                    
                    const putRes = await fetch(API + '/properties/' + id, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    
                    if (putRes.ok) {
                        showToast('æˆ¿æºå·²æ›´æ–°');
                        closeModal();
                        loadProperties();
                    } else {
                        showToast('æ›´æ–°å¤±æ•—');
                    }
                };
                
                openModal();
            } catch(e) {
                showToast('è¼‰å…¥å¤±æ•—');
            }
        }

        function handleFabClick() {
            haptic();
            if (currentPage === 'orders') {
                showOrderModal();
            } else {
                showPropertyModal();
            }
        }

        function showOrderModal() {
            document.getElementById('modalTitle').textContent = "ç™¼å¸ƒæ–°æ¸…æ½”ä»»å‹™";
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">é¸æ“‡æˆ¿æº</label>
                    <select class="input-premium" id="orderPropId"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">é€€æˆ¿æ™‚é–“</label>
                    <input type="datetime-local" class="input-premium" id="orderTime">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¸…æ½”å ±åƒ¹ (TWD)</label>
                    <input type="number" class="input-premium" id="orderPrice" placeholder="1200">
                </div>
            `;
            // å¡«å……æˆ¿æºä¸‹æ‹‰èœå–®
            fetch(API + '/properties').then(r => r.json()).then(d => {
                const props = d.data || [];
                document.getElementById('orderPropId').innerHTML = props.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            });
            
            document.getElementById('modalSubmit').onclick = async () => {
                const body = {
                    property_id: parseInt(document.getElementById('orderPropId').value),
                    checkout_time: document.getElementById('orderTime').value,
                    price: parseInt(document.getElementById('orderPrice').value),
                    host_phone: hostPhone,
                    status: 'open'
                };
                const res = await fetch(`${API}/orders`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(body) 
                });
                if(res.ok) { showToast('ä»»å‹™å·²ç™¼å¸ƒï¼'); closeModal(); loadOrders(); }
            };
            openModal();
        }

        function showPropertyModal() {
            document.getElementById('modalTitle').textContent = "æ–°å¢æˆ¿æºè³‡è¨Š";
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">æˆ¿æºåç¨±</label>
                    <input type="text" class="input-premium" id="propName" placeholder="ä¾‹å¦‚ï¼šä¿¡ç¾©å€æ™¯è§€å¥—æˆ¿">
                </div>
                <div class="form-group">
                    <label class="form-label">å®Œæ•´åœ°å€</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" class="input-premium" id="propAddr" placeholder="è«‹è¼¸å…¥è©³ç´°åœ°å€" style="flex:1;">
                        <button type="button" onclick="verifyAddress()" style="padding:0 16px; border-radius:16px; border:none; background:var(--primary); color:white; font-weight:700; white-space:nowrap;">é©—è­‰</button>
                    </div>
                    <div id="addrStatus" style="font-size:12px; margin-top:6px; font-weight:600;"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
                    <div class="form-group">
                        <label class="form-label">çœ/å·</label>
                        <input type="text" class="input-premium" id="propProvince" placeholder="ä¾‹å¦‚ï¼šè‡ºåŒ—å¸‚">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¸‚/å€</label>
                        <input type="text" class="input-premium" id="propCity" placeholder="ä¾‹å¦‚ï¼šä¿¡ç¾©å€">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:12px">
                    <div class="form-group">
                        <label class="form-label">è¡—é“</label>
                        <input type="text" class="input-premium" id="propStreet" placeholder="ä¾‹å¦‚ï¼šå¿ å­æ±è·¯">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é–€ç‰Œ</label>
                        <input type="text" class="input-premium" id="propHouseNum" placeholder="ä¾‹å¦‚ï¼š123">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">éƒµéå€è™Ÿ</label>
                    <input type="text" class="input-premium" id="propPostal" placeholder="ä¾‹å¦‚ï¼š110">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px">
                    <div class="form-group">
                        <label class="form-label">è‡¥å®¤</label>
                        <input type="number" class="input-premium" id="propBed" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¡›æµ´</label>
                        <input type="number" class="input-premium" id="propBath" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨“å±¤</label>
                        <input type="number" class="input-premium" id="propFloor" value="1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">é¢ç© (sqft)</label>
                    <input type="number" class="input-premium" id="propArea" value="800">
                </div>
            `;
            document.getElementById('modalSubmit').onclick = async () => {
                const name = document.getElementById('propName').value.trim();
                const address = document.getElementById('propAddr').value.trim();
                if (!name) { showToast('è«‹è¼¸å…¥æˆ¿æºåç¨±'); return; }
                if (!address) { showToast('è«‹è¼¸å…¥åœ°å€'); return; }
                
                const btn = document.getElementById('modalSubmit');
                btn.disabled = true;
                btn.textContent = 'æäº¤ä¸­...';
                
                const body = {
                    name: name,
                    address: address,
                    province: document.getElementById('propProvince').value.trim(),
                    city: document.getElementById('propCity').value.trim(),
                    street: document.getElementById('propStreet').value.trim(),
                    house_number: document.getElementById('propHouseNum').value.trim(),
                    postal_code: document.getElementById('propPostal').value.trim(),
                    bedrooms: parseInt(document.getElementById('propBed').value) || 1,
                    bathrooms: parseInt(document.getElementById('propBath').value) || 1,
                    floor: parseInt(document.getElementById('propFloor').value) || 1,
                    area: parseInt(document.getElementById('propArea').value) || 800,
                    host_phone: hostPhone
                };
                const res = await fetch(`${API}/properties`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(body) 
                });
                if(res.ok) { showToast('æˆ¿æºå·²æ·»åŠ '); closeModal(); loadProperties(); }
                else { const err = await res.json(); showToast(err.error || 'æ·»åŠ å¤±æ•—'); btn.disabled = false; btn.textContent = 'ç¢ºèªæäº¤'; }
            };
            openModal();
        }

        async function verifyAddress() {
            const addr = document.getElementById('propAddr').value.trim();
            const status = document.getElementById('addrStatus');
            if (!addr) { showToast('è«‹å…ˆè¼¸å…¥åœ°å€'); return; }
            
            status.textContent = 'ğŸ”„ é©—è­‰ä¸­...';
            status.style.color = 'var(--text-muted)';
            
            try {
                const res = await fetch(`${API}/geocode?address=${encodeURIComponent(addr)}`);
                const data = await res.json();
                if (data.success) {
                    status.textContent = 'âœ… åœ°å€é©—è­‰æˆåŠŸ';
                    status.style.color = 'oklch(70% 0.18 150)';
                    
                    // è‡ªå‹•å¡«å……çœã€å¸‚ã€è¡—é“ã€é–€ç‰Œã€éƒµéå€è™Ÿ
                    if (data.province) document.getElementById('propProvince').value = data.province;
                    if (data.city) document.getElementById('propCity').value = data.city;
                    if (data.street) document.getElementById('propStreet').value = data.street;
                    if (data.house_number) document.getElementById('propHouseNum').value = data.house_number;
                    if (data.postcode) document.getElementById('propPostal').value = data.postcode;
                } else {
                    status.textContent = 'âŒ ' + (data.error || 'åœ°å€ç„¡æ³•è­˜åˆ¥');
                    status.style.color = 'oklch(55% 0.18 25)';
                }
            } catch(e) {
                status.textContent = 'âš ï¸ é©—è­‰å¤±æ•—ï¼Œè«‹é‡è©¦';
                status.style.color = 'oklch(55% 0.18 25)';
            }
        }

        async function deleteOrder(id) {
            if(!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿ')) return;
            await fetch(`${API}/orders/${id}`, { method: 'DELETE' });
            showToast('å·²å–æ¶ˆè¨‚å–®');
            loadOrders();
        }

        async function editOrder(id) {
            try {
                const res = await fetch(API + '/orders');
                const data = await res.json();
                const order = (data.data || []).find(o => o.id === id);
                if (!order) { showToast('è¨‚å–®ä¸å­˜åœ¨'); return; }
                
                // ç²å–æˆ¿æºåˆ—è¡¨
                const propsRes = await fetch(API + '/properties');
                const propsData = await propsRes.json();
                const properties = propsData.data || [];
                
                document.getElementById('modalTitle').textContent = "ä¿®æ”¹è¨‚å–®";
                document.getElementById('modalBody').innerHTML = `
                    <div class="form-group">
                        <label class="form-label">é¸æ“‡æˆ¿æº</label>
                        <select class="input-premium" id="orderPropId"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é€€æˆ¿æ™‚é–“</label>
                        <input type="datetime-local" class="input-premium" id="orderTime" value="${order.checkout_time || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¸…æ½”å ±åƒ¹ (TWD)</label>
                        <input type="number" class="input-premium" id="orderPrice" value="${order.price || 100}">
                    </div>
                `;
                
                // å¡«å……æˆ¿æºä¸‹æ‹‰èœå–®ä¸¦é¸ä¸­ç•¶å‰
                const propSelect = document.getElementById('orderPropId');
                propSelect.innerHTML = properties.map(p => 
                    `<option value="${p.id}" ${p.id === order.property_id ? 'selected' : ''}>${p.name}</option>`
                ).join('');
                
                document.getElementById('modalSubmit').onclick = async () => {
                    const body = {
                        property_id: parseInt(document.getElementById('orderPropId').value),
                        checkout_time: document.getElementById('orderTime').value,
                        price: parseInt(document.getElementById('orderPrice').value)
                    };
                    
                    const putRes = await fetch(API + '/orders/' + id, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    
                    if (putRes.ok) {
                        showToast('è¨‚å–®å·²æ›´æ–°');
                        closeModal();
                        loadOrders();
                    } else {
                        showToast('æ›´æ–°å¤±æ•—');
                    }
                };
                
                openModal();
            } catch(e) {
                showToast('è¼‰å…¥å¤±æ•—');
            }
        }

        function translateStatus(s) {
            return { 'open': 'å¾…æ¥å–®', 'accepted': 'å·¥ä½œä¸­', 'completed': 'å·²å®Œæˆ' }[s] || s;
        }

        function openModal() { document.getElementById('globalModal').classList.add('active'); }
        function closeModal() { document.getElementById('globalModal').classList.remove('active'); }

        async function submitProperty() {
            const name = document.getElementById("propName").value.trim();
            const address = document.getElementById("propAddr").value.trim();
            if (!name) { showToast("è«‹è¼¸å…¥æˆ¿æºåç¨±"); return; }
            if (!address) { showToast("è«‹è¼¸å…¥åœ°å€"); return; }
            const btn = document.getElementById("modalSubmit");
            btn.disabled = true;
            btn.textContent = "æäº¤ä¸­...";
            const res = await fetch(API + "/properties", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    name: name,
                    address: address,
                    bedrooms: parseInt(document.getElementById("propBed").value) || 1,
                    bathrooms: parseInt(document.getElementById("propBath").value) || 1,
                    floor: parseInt(document.getElementById("propFloor").value) || 1,
                    area: parseInt(document.getElementById("propArea").value) || 800,
                    host_phone: hostPhone
                })
            });
            if (res.ok) { showToast("æˆ¿æºå·²æ·»åŠ "); closeModal(); loadProperties(); }
            else { const err = await res.json(); showToast(err.error || "æ·»åŠ å¤±æ•—"); btn.disabled = false; btn.textContent = "ç¢ºèªæäº¤"; }
        }

                async function submitProperty() {
            const name = document.getElementById('propName').value.trim();
            const address = document.getElementById('propAddr').value.trim();
            if (!name) { showToast('è«‹è¼¸å…¥æˆ¿æºåç¨±'); return; }
            if (!address) { showToast('è«‹è¼¸å…¥åœ°å€'); return; }
            const btn = document.getElementById('modalSubmit');
            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';
            const res = await fetch(API + '/properties', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({
                    name: name,
                    address: address,
                    bedrooms: parseInt(document.getElementById('propBed').value) || 1,
                    bathrooms: parseInt(document.getElementById('propBath').value) || 1,
                    floor: parseInt(document.getElementById('propFloor').value) || 1,
                    area: parseInt(document.getElementById('propArea').value) || 800,
                    host_phone: hostPhone
                })
            });
            if (res.ok) { showToast('æˆ¿æºå·²æ·»åŠ '); closeModal(); loadProperties(); } 
            else { const err = await res.json(); showToast(err.error || 'æ·»åŠ å¤±æ•—'); btn.disabled = false; btn.textContent = 'ç¢ºèªæäº¤'; }
        }

function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        async function submitProperty() {
            const name = document.getElementById('propName').value.trim();
            const address = document.getElementById('propAddr').value.trim();
            if (!name) { showToast('è«‹è¼¸å…¥æˆ¿æºåç¨±'); return; }
            if (!address) { showToast('è«‹è¼¸å…¥åœ°å€'); return; }
            const btn = document.getElementById('modalSubmit');
            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';
            const res = await fetch(API + '/properties', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({
                    name: name,
                    address: address,
                    bedrooms: parseInt(document.getElementById('propBed').value) || 1,
                    bathrooms: parseInt(document.getElementById('propBath').value) || 1,
                    floor: parseInt(document.getElementById('propFloor').value) || 1,
                    area: parseInt(document.getElementById('propArea').value) || 800,
                    host_phone: hostPhone
                })
            });
            if (res.ok) { showToast('æˆ¿æºå·²æ·»åŠ '); closeModal(); loadProperties(); } 
            else { const err = await res.json(); showToast(err.error || 'æ·»åŠ å¤±æ•—'); btn.disabled = false; btn.textContent = 'ç¢ºèªæäº¤'; }
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // åˆå§‹åŒ–
        loadOrders();
    
    </script>
</body>
</html>