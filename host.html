<!doctype html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <meta name="theme-color" content="#FAFBFF" />
        <title>ğŸ  æˆ¿æ±æ§åˆ¶å° - çŸ­ç§Ÿæ¸…æ½”ç³»çµ±</title>
        <style>
            /* ========================================
           2026 Flagship Unified Design System
           ======================================== */
            @layer base, components, utilities;

            :root {
                /* æ ¸å¿ƒèª¿è‰²æ¿ - OKLCH é«˜é€šé€æ„Ÿ */
                --primary: oklch(60% 0.2 250);
                --primary-light: oklch(92% 0.04 250);
                --bg-main: oklch(98.5% 0.01 240);
                --surface: oklch(100% 0 0 / 92%);
                --midnight: oklch(25% 0.02 240);
                --text-muted: oklch(55% 0.02 240);

                /* ç‰©ç†ç³»çµ±åƒæ•¸ */
                --radius-xl: 32px;
                --radius-lg: 24px;
                --radius-md: 16px;
                --shadow-premium: 0 20px 40px -12px oklch(0% 0 0 / 8%);
                --shadow-fab: 0 12px 28px -6px oklch(60% 0.2 250 / 35%);
            }

            * {
                box-sizing: border-box;
                -webkit-tap-highlight-color: transparent;
                margin: 0;
                padding: 0;
            }

            body {
                /*background: var(--bg-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: var(--midnight);
            line-height: 1.5;
            padding-bottom: 120px;
            -webkit-font-smoothing: antialiased;*/

                background: var(--bg-canvas);
                font-family: "Inter", system-ui, sans-serif;
                color: var(--midnight);
                padding-bottom: env(safe-area-inset-bottom);
                background-image:
                    radial-gradient(
                        circle at 0% 0%,
                        oklch(85% 0.08 250 / 20%),
                        transparent 40%
                    ),
                    radial-gradient(
                        circle at 100% 100%,
                        oklch(85% 0.12 320 / 15%),
                        transparent 40%
                    );
                background-attachment: fixed;
                min-height: 100vh;
            }

            /* --- é ‚éƒ¨ç»ç’ƒæ„Ÿå°èˆª --- */
            header {
                /*position: sticky; top: 0; z-index: 1000;
            background: oklch(100% 0 0 / 75%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 18px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid oklch(0% 0 0 / 5%);*/
                position: sticky;
                top: 0;
                z-index: 100;
                padding: calc(env(safe-area-inset-top) + 16px) 20px 16px;
                background: rgba(255, 255, 255, 0.6);
                backdrop-filter: blur(20px) saturate(180%);
                border-bottom: 1px solid rgba(255, 255, 255, 0.3);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            header h1 {
                font-size: 20px;
                font-weight: 800;
                letter-spacing: -0.5px;
            }

            .logout-btn {
                padding: 8px 16px;
                border-radius: 50px;
                border: 1px solid oklch(0% 0 0 / 8%);
                background: white;
                font-size: 13px;
                font-weight: 700;
                transition: 0.2s cubic-bezier(0.2, 1, 0.3, 1);
            }
            .logout-btn:active {
                transform: scale(0.92);
                opacity: 0.8;
            }

            /* --- ä¸»å®¹å™¨èˆ‡é é¢å‹•ç•« --- */
            .container {
                max-width: 500px;
                margin: 0 auto;
                padding: 20px;
            }
            .page {
                animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            }
            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(24px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .page-title {
                font-size: 26px;
                font-weight: 850;
                margin-bottom: 24px;
                letter-spacing: -1px;
            }

            /* --- å¡ç‰‡é«”ç³» --- */
            .card {
                background: white;
                border-radius: var(--radius-lg);
                padding: 22px;
                margin-bottom: 18px;
                box-shadow: var(--shadow-premium);
                border: 1px solid oklch(100% 0 0 / 10%);
                transition: transform 0.4s cubic-bezier(0.2, 1, 0.3, 1);
                position: relative;
                overflow: hidden;
            }
            .card:active {
                transform: scale(0.985);
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
            }
            .card-title {
                font-size: 18px;
                font-weight: 800;
                color: var(--midnight);
                flex: 1;
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            .price-display {
                font-size: 22px;
                font-weight: 850;
                color: var(--midnight);
            }
            .price-display::before {
                content: "$";
                font-size: 14px;
                margin-right: 2px;
                color: var(--text-muted);
            }

            .info-row {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                color: var(--text-muted);
                margin-top: 6px;
            }

            /* --- ç‹€æ…‹æ¨™ç±¤ --- */
            .badge {
                padding: 4px 12px;
                border-radius: 10px;
                font-size: 11px;
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .status-open {
                background: oklch(96% 0.1 85);
                color: oklch(50% 0.15 45);
            }
            .status-accepted {
                background: oklch(93% 0.08 240);
                color: oklch(55% 0.15 250);
            }
            .status-completed {
                background: oklch(96% 0.15 45);
                color: oklch(55% 0.18 45);
            }
            .status-accepted_by_host {
                background: oklch(94% 0.08 160);
                color: oklch(50% 0.15 155);
            }
            .badge.status-completed-accepted {
                background: oklch(85% 0.15 150);
                color: oklch(25% 0.1 150);
            }

            .property-meta {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-top: 16px;
            }
            .meta-tag {
                background: var(--bg-main);
                padding: 5px 10px;
                border-radius: 10px;
                font-size: 12px;
                font-weight: 600;
                color: oklch(40% 0.02 240);
            }

            /* --- æŒ‰éˆ•çµ„ --- */
            .action-row {
                display: flex;
                gap: 10px;
                margin-top: 20px;
                padding-top: 16px;
                border-top: 1px solid oklch(0% 0 0 / 5%);
            }
            .btn-mini {
                flex: 1;
                padding: 12px;
                border-radius: 14px;
                border: none;
                font-size: 14px;
                font-weight: 700;
                cursor: pointer;
                transition: 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }
            .btn-edit {
                background: var(--primary-light);
                color: var(--primary);
            }
            .btn-del {
                background: #fff1f2;
                color: #e11d48;
            }
            .btn-mini:active {
                transform: scale(0.94);
            }

            /* --- åº•éƒ¨æ‡¸æµ®å°èˆª --- */
            .bottom-nav {
                position: fixed;
                bottom: 28px;
                left: 50%;
                transform: translateX(-50%);
                background: oklch(25% 0.02 240 / 88%);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                padding: 8px;
                border-radius: 50px;
                display: flex;
                gap: 4px;
                box-shadow: 0 20px 48px oklch(0% 0 0 / 25%);
                z-index: 1000;
                width: fit-content;
            }
            .nav-item {
                padding: 12px 28px;
                border-radius: 40px;
                color: white;
                opacity: 0.5;
                font-size: 15px;
                font-weight: 700;
                border: none;
                background: none;
                transition: 0.3s;
            }
            .nav-item.active {
                background: white;
                color: var(--midnight);
                opacity: 1;
            }

            /* --- ç‰©ç†æŒ‰å£“ FAB --- */
            .fab {
                position: fixed;
                bottom: 105px;
                right: 24px;
                width: 64px;
                height: 64px;
                border-radius: 22px;
                background: var(--midnight);
                color: white;
                border: none;
                font-size: 32px;
                box-shadow: var(--shadow-fab);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 900;
                transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            .fab:active {
                transform: scale(0.85) rotate(90deg);
            }

            /* --- æ¨¡æ…‹æ¡† Premium --- */
            .modal {
                position: fixed;
                inset: 0;
                background: oklch(0% 0 0 / 30%);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                display: none;
                align-items: flex-end;
                justify-content: center;
                z-index: 2000;
                opacity: 0;
                transition: 0.3s;
            }
            .modal.active {
                display: flex;
                opacity: 1;
            }

            .modal-content {
                background: white;
                border-radius: 32px 32px 0 0;
                padding: 32px 24px 18px;
                width: 100%;
                max-width: 500px;
                transform: translateY(100%);
                transition: 0.4s cubic-bezier(0.2, 1, 0.3, 1);
            }
            .modal.active .modal-content {
                transform: translateY(0);
            }

            /* --- è¡¨å–® --- */
            .form-group {
                margin-bottom: 20px;
            }
            .form-label {
                display: block;
                font-size: 13px;
                font-weight: 700;
                margin-bottom: 8px;
                color: var(--text-muted);
                margin-left: 4px;
            }
            .input-premium {
                width: 100%;
                padding: 16px;
                background: #f5f5f5;
                border: 2px solid transparent;
                border-radius: var(--radius-md);
                font-size: 16px;
                font-weight: 600;
                transition: 0.3s;
                word-wrap: break-word;
                overflow-wrap: break-word;
                color: var(--midnight);
            }
            .input-premium::placeholder {
                color: #999;
            }
            .input-premium:focus {
                background: white;
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 4px var(--primary-light);
            }
            .sort-select {
                width: 100%;
                padding: 14px 16px;
                border-radius: 14px;
                border: 2px solid oklch(90% 0.02 240);
                background: white;
                font-size: 15px;
                font-weight: 600;
                color: var(--midnight);
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='3'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 16px center;
            }

            .btn-submit {
                background: var(--midnight);
                color: white;
                width: 100%;
                padding: 18px;
                border-radius: 50px;
                font-weight: 700;
                font-size: 16px;
                border: none;
                cursor: pointer;
                transition: 0.3s;
                margin-top: 10px;
            }
            .btn-submit:active {
                transform: scale(0.96);
            }

            .toast {
                position: fixed;
                bottom: 120px;
                left: 50%;
                transform: translate(-50%, 40px);
                background: var(--midnight);
                color: white;
                padding: 14px 28px;
                border-radius: 50px;
                font-size: 14px;
                font-weight: 700;
                opacity: 0;
                transition: 0.4s cubic-bezier(0.2, 1, 0.3, 1);
                z-index: 3000;
            }
            .toast.show {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            /* éŒ„éŸ³æŒ‰éˆ• */
            .voice-record {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
                padding: 24px 20px;
                background: oklch(96% 0.02 240);
                border-radius: var(--radius-md);
                margin-bottom: 20px;
            }
            .record-btn {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                border: none;
                background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
                color: white;
                font-size: 32px;
                cursor: pointer;
                box-shadow: 0 8px 24px rgba(238, 90, 90, 0.4);
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .record-btn:active {
                transform: scale(0.9);
            }
            .record-btn.recording {
                background: linear-gradient(135deg, #ff4757, #ff3838);
                animation: pulse 1s infinite;
            }
            .record-hint {
                font-size: 14px;
                color: oklch(45% 0.02 240);
                font-weight: 600;
                background: white;
                padding: 8px 16px;
                border-radius: 20px;
            }
            .audio-preview {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 16px;
                background: white;
                border-radius: 12px;
                width: 100%;
                border: 1.5px solid oklch(90% 0.02 240);
            }
            .audio-preview audio {
                flex: 1;
                height: 36px;
            }
            .audio-preview .del-audio {
                padding: 8px 12px;
                border-radius: 8px;
                border: none;
                background: #fff1f2;
                color: #e11d48;
                font-weight: 700;
                cursor: pointer;
            }

            /* è¨‚å–®å…§éŒ„éŸ³æŒ‰éˆ• */
            .voice-record-btn {
                width: 100%;
                padding: 16px;
                border-radius: 14px;
                border: 2px dashed oklch(80% 0.05 280);
                background: transparent;
                color: var(--text-muted);
                font-weight: 700;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s;
                user-select: none;
                -webkit-user-select: none;
                touch-action: manipulation;
            }
            .voice-record-btn.recording {
                border-style: solid;
                background: #ffebee;
                color: #e53935;
                animation: pulse 1s infinite;
            }

            /* éŒ„éŸ³é è¦½ */
            .voice-preview-box {
                padding: 16px;
                background: white;
                border-radius: 14px;
                border: 2px solid var(--primary);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }

            /* å·²ä¿å­˜çš„éŒ„éŸ³ */
            .voice-exist {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .voice-exist audio {
                width: 100%;
                height: 40px;
            }
            .voice-del-btn {
                width: 100%;
                padding: 16px;
                border-radius: 14px;
                border: none;
                background: #fff1f2;
                color: #e53935;
                font-size: 16px;
                font-weight: 700;
                cursor: pointer;
                touch-action: manipulation;
            }
            .voice-del-btn:active {
                background: #ffcdd2;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>ç‰©ä¸šç®¡ç†</h1>
            <button class="logout-btn" onclick="logout()">ç™»å‡ºç³»ç»Ÿ</button>
        </header>

        <div class="container">
            <main id="pageOrders" class="page">
                <h2 class="page-title">ç•¶å‰è¨‚å–®</h2>
                <select class="sort-select" id="orderFilter" onchange="loadOrders()" style="margin-bottom:16px;">
                    <option value="all">ğŸ“‹ å…¨éƒ¨è¨‚å–®</option>
                    <option value="open">â³ å¾…æ¥å–®</option>
                    <option value="accepted">ğŸ”„ é€²è¡Œä¸­</option>
                    <option value="completed">â° å¾…é©—æ”¶</option>
                    <option value="accepted_by_host">âœ… å·²é©—æ”¶</option>
                </select>
                <div id="hostOrdersList"></div>
            </main>

            <main id="pageProperties" class="page" style="display: none">
                <h2 class="page-title">æˆ¿æºç®¡ç†</h2>
                <div id="myPropertiesList"></div>
            </main>
        </div>

        <button class="fab" id="mainFab" onclick="handleFabClick()">+</button>

        <nav class="bottom-nav">
            <button
                class="nav-item active"
                id="btnNavOrders"
                onclick="switchPage('orders')"
            >
                ğŸ“‹<br />è¨‚å–®
            </button>
            <button
                class="nav-item"
                id="btnNavProperties"
                onclick="switchPage('properties')"
            >
                ğŸ¡<br />æˆ¿æº
            </button>
        </nav>

        <div class="modal" id="globalModal">
            <div class="modal-content">
                <h2
                    id="modalTitle"
                    style="
                        margin-bottom: 28px;
                        text-align: center;
                        font-size: 22px;
                        font-weight: 850;
                    "
                ></h2>
                <div id="modalBody"></div>
                <button
                    class="btn-submit"
                    id="modalSubmit"
                    onclick="submitProperty()"
                >
                    ç¢ºèªæäº¤
                </button>
                <button
                    style="
                        width: 100%;
                        background: none;
                        border: none;
                        color: var(--text-muted);
                        font-weight: 700;
                        margin-top: 16px;
                        cursor: pointer;
                    "
                    onclick="closeModal()"
                >
                    å–æ¶ˆ
                </button>
            </div>
        </div>

        <!-- å®Œå·¥ç…§ç‰‡ç”»å»ŠModal -->
        <div
            class="modal"
            id="photoGalleryModal"
            style="background: rgba(0, 0, 0, 0.9)"
        >
            <div
                style="
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                "
            >
                <div
                    style="
                        padding: 16px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    "
                >
                    <span
                        style="color: white; font-size: 18px; font-weight: 800"
                        >ğŸ“¸ å®Œå·¥ç…§ç‰‡</span
                    >
                    <button
                        onclick="closePhotoGallery()"
                        style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 24px;
                            cursor: pointer;
                        "
                    >
                        âœ•
                    </button>
                </div>
                <div
                    id="photoGalleryContent"
                    style="flex: 1; overflow: auto; padding: 16px"
                ></div>
                <div id="photoGalleryActions" style="padding: 16px"></div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
            const API = "https://biggish-londyn-unconvolute.ngrok-free.dev/api";
            const hostPhone = localStorage.getItem("host_phone");
            let currentPage = "orders";

            if (!hostPhone) {
                location.href = "index.html";
            }
            function logout() {
                localStorage.clear();
                location.href = "index.html";
            }

            function haptic() {
                if (navigator.vibrate) navigator.vibrate(20);
            }

            function switchPage(page) {
                haptic();
                currentPage = page;
                document
                    .querySelectorAll(".page")
                    .forEach((p) => (p.style.display = "none"));
                document.getElementById(
                    `page${page.charAt(0).toUpperCase() + page.slice(1)}`,
                ).style.display = "block";

                document
                    .querySelectorAll(".nav-item")
                    .forEach((n) => n.classList.remove("active"));
                document
                    .getElementById(
                        `btnNav${page.charAt(0).toUpperCase() + page.slice(1)}`,
                    )
                    .classList.add("active");

                page === "orders" ? loadOrders() : loadProperties();
            }

            async function loadOrders() {
                try {
                    const res = await fetch(`${API}/orders`);
                    const data = await res.json();
                    const filter = document.getElementById("orderFilter")?.value || "all";
                    let orders = (data.data || []).filter(
                        (o) => o.host_phone === hostPhone,
                    );
                    // æ ¹æ“šç¯©é¸æ¢ä»¶éæ¿¾
                    if (filter !== "all") {
                        if (filter === "accepted_by_host") {
                            orders = orders.filter(o => o.status === 'completed' && o.accepted_by_host === 1);
                        } else {
                            orders = orders.filter(o => o.status === filter);
                        }
                    }

                    document.getElementById("hostOrdersList").innerHTML =
                        orders
                            .map(
                                (o) => `
                    <div class="card" onclick="${o.status === "completed" ? `viewOrderPhotos(${o.id}, '${encodeURIComponent(JSON.stringify(o.completion_photos || []))}', ${o.accepted_by_host || 0})` : ""}" style="${o.status === "completed" ? "cursor:pointer" : ""}">
                        <div class="card-header">
                            <span class="badge ${o.status === 'completed' && o.accepted_by_host ? 'status-completed-accepted' : 'status-' + o.status}">${translateStatus(o.status, o.accepted_by_host)}</span>
                            <div class="price-display">${o.price}</div>
                        </div>
                        <div class="card-title">${o.property_name || "æœªå‘½åæˆ¿æº"}</div>
                        <div class="info-row">ğŸ“ ${o.property_address || "ç„¡åœ°å€è³‡è¨Š"}</div>
                        <div class="info-row">ğŸ• é€€æˆ¿æ™‚é–“: ${o.checkout_time}</div>

                        ${
                            o.status === "open"
                                ? `
                        <div class="order-voice">
                            <div class="order-voice-label">ğŸ¤ èªéŸ³å‚™è¨»</div>
                            ${
                                o.voice_url
                                    ? `
                                <div class="voice-exist">
                                    <audio controls src="${o.voice_url}"></audio>
                                    <button class="voice-del-btn" onclick="deleteVoice(${o.id})">ğŸ—‘ï¸ åˆªé™¤éŒ„éŸ³</button>
                                </div>
                            `
                                    : `
                                <div class="voice-preview-box" id="preview-${o.id}" style="display:none; margin-bottom:10px;">
                                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">ğŸ”Š é è¦½éŒ„éŸ³ï¼š</div>
                                    <audio controls id="previewAudio-${o.id}" style="width:100%;"></audio>
                                    <div style="display:flex;gap:8px;margin-top:8px;">
                                        <button class="voice-save-btn" onclick="saveVoice(${o.id})" style="flex:1;padding:12px;border-radius:10px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;">âœ… ç¢ºèªä¿å­˜</button>
                                        <button class="voice-cancel-btn" onclick="cancelVoice(${o.id})" style="padding:12px;border-radius:10px;border:1px solid #ddd;background:white;color:#666;font-weight:700;cursor:pointer;">âœ• å–æ¶ˆ</button>
                                    </div>
                                </div>
                                <button class="voice-record-btn" id="recordBtn-${o.id}"
                                    onmousedown="event.preventDefault();startRecord(${o.id})"
                                    onmouseup="event.preventDefault();stopRecord(${o.id})"
                                    ontouchstart="event.preventDefault();startRecord(${o.id})"
                                    ontouchend="event.preventDefault();stopRecord(${o.id})">
                                    ğŸ¤ æŒ‰ä½éŒ„éŸ³ï¼ˆæœ€é•·20ç§’ï¼‰
                                </button>
                            `
                            }
                        </div>
                        `
                                : ""
                        }

                        ${
                            o.status === "completed"
                                ? `
                        <div class="completion-section">
                            <div class="info-row" style="margin-top:12px;">ğŸ“¸ å®Œå·¥ç…§ç‰‡</div>
                            ${renderHostCompletionPhotos(o.completion_photos, o.id, o.accepted_by_host || 0)}
                        </div>
                        `
                                : ""
                        }

                        ${
                            o.status === "open"
                                ? `
                            <div class="action-row">
                                <button class="btn-mini btn-edit" onclick="editOrder(${o.id})">âœï¸ ç·¨è¼¯</button>
                                <button class="btn-mini btn-del" onclick="deleteOrder(${o.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                            </div>
                        `
                                : ""
                        }
                    </div>
                `,
                            )
                            .join("") ||
                        '<div style="text-align:center; padding:60px; color:gray; font-weight:600;">â˜• æš«ç„¡è¨‚å–®ï¼Œé»æ“Š + è™Ÿç™¼å¸ƒ</div>';
                } catch (e) {
                    showToast("åŠ è¼‰å¤±æ•—");
                }
            }

            async function loadProperties() {
                try {
                    const res = await fetch(API + "/properties");
                    const data = await res.json();
                    // åªé¡¯ç¤ºç•¶å‰ç”¨æˆ¶çš„æˆ¿æº
                    const properties = (data.data || []).filter(
                        (p) => p.host_phone === hostPhone,
                    );

                    if (properties.length === 0) {
                        document.getElementById("myPropertiesList").innerHTML =
                            '<div class="empty-state">å°šæœªæ·»åŠ æˆ¿æº<br>é»æ“Šä¸‹æ–¹+æŒ‰éˆ•æ·»åŠ </div>';
                        return;
                    }

                    document.getElementById("myPropertiesList").innerHTML =
                        properties
                            .map(
                                (p) => `
                    <div class="card">
                        <div class="card-title">${p.name}</div>
                        <div class="info-row">ğŸ“ ${p.address}</div>
                        <div class="property-meta">
                            <span class="meta-tag">ğŸ›ï¸ ${p.bedrooms || 0} è‡¥å®¤</span>
                            <span class="meta-tag">ğŸš¿ ${p.bathrooms || 0} è¡›æµ´</span>
                            <span class="meta-tag">ğŸ“ ${p.area || 0} sqft</span>
                        </div>
                        <div class="action-row">
                            <button class="btn-mini btn-edit" onclick="editProperty(${p.id})">âœï¸ ä¿®æ”¹è³‡è¨Š</button>
                            <button class="btn-mini btn-del" onclick="deleteProperty(${p.id})">ğŸ—‘ï¸ ç§»é™¤</button>
                        </div>
                    </div>
                `,
                            )
                            .join("") ||
                        '<div style="text-align:center; padding:60px; color:gray; font-weight:600;">ğŸ¡ é»æ“Š + è™Ÿæ–°å¢æ‚¨çš„æˆ¿æº</div>';
                } catch (e) {
                    showToast("åŠ è¼‰æˆ¿æºå¤±æ•—");
                }
            }

            async function deleteProperty(id) {
                if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æˆ¿æºå—ï¼Ÿ")) return;
                try {
                    const res = await fetch(API + "/properties/" + id, {
                        method: "DELETE",
                    });
                    if (res.ok) {
                        showToast("æˆ¿æºå·²åˆªé™¤");
                        loadProperties();
                    } else {
                        showToast("åˆªé™¤å¤±æ•—");
                    }
                } catch (e) {
                    showToast("åˆªé™¤å¤±æ•—");
                }
            }

            async function editProperty(id) {
                try {
                    const res = await fetch(API + "/properties/" + id);
                    const data = await res.json();
                    const p = data.data;
                    if (!p) {
                        showToast("æˆ¿æºä¸å­˜åœ¨");
                        return;
                    }

                    document.getElementById("modalTitle").textContent =
                        "ä¿®æ”¹æˆ¿æºè³‡è¨Š";
                    document.getElementById("modalBody").innerHTML = `
                    <div class="form-group">
                        <label class="form-label">æˆ¿æºåç¨±</label>
                        <input type="text" class="input-premium" id="propName" value="${p.name || ""}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å®Œæ•´åœ°å€</label>
                        <div style="display:flex; gap:8px;">
                            <input type="text" class="input-premium" id="propAddr" value="${p.address || ""}" style="flex:1;">
                            <button type="button" onclick="verifyAddress()" style="padding:0 16px; border-radius:16px; border:none; background:var(--primary); color:white; font-weight:700; white-space:nowrap;">é©—è­‰</button>
                        </div>
                        <div id="addrStatus" style="font-size:12px; margin-top:6px; font-weight:600;"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
                        <div class="form-group">
                            <label class="form-label">çœ/å·</label>
                            <input type="text" class="input-premium" id="propProvince" value="${p.province || ""}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¸‚/å€</label>
                            <input type="text" class="input-premium" id="propCity" value="${p.city || ""}">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:12px">
                        <div class="form-group">
                            <label class="form-label">è¡—é“</label>
                            <input type="text" class="input-premium" id="propStreet" value="${p.street || ""}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é–€ç‰Œ</label>
                            <input type="text" class="input-premium" id="propHouseNum" value="${p.house_number || ""}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">éƒµéå€è™Ÿ</label>
                        <input type="text" class="input-premium" id="propPostal" value="${p.postal_code || ""}">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px">
                        <div class="form-group">
                            <label class="form-label">è‡¥å®¤</label>
                            <input type="number" class="input-premium" id="propBed" value="${p.bedrooms || 1}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¡›æµ´</label>
                            <input type="number" class="input-premium" id="propBath" value="${p.bathrooms || 1}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¨“å±¤</label>
                            <input type="number" class="input-premium" id="propFloor" value="${p.floor || 1}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¢ç© (sqft)</label>
                        <input type="number" class="input-premium" id="propArea" value="${p.area || 800}">
                    </div>
                `;

                    document.getElementById("modalSubmit").onclick =
                        async () => {
                            const body = {
                                name: document
                                    .getElementById("propName")
                                    .value.trim(),
                                address: document
                                    .getElementById("propAddr")
                                    .value.trim(),
                                province: document
                                    .getElementById("propProvince")
                                    .value.trim(),
                                city: document
                                    .getElementById("propCity")
                                    .value.trim(),
                                street: document
                                    .getElementById("propStreet")
                                    .value.trim(),
                                house_number: document
                                    .getElementById("propHouseNum")
                                    .value.trim(),
                                postal_code: document
                                    .getElementById("propPostal")
                                    .value.trim(),
                                bedrooms:
                                    parseInt(
                                        document.getElementById("propBed")
                                            .value,
                                    ) || 1,
                                bathrooms:
                                    parseInt(
                                        document.getElementById("propBath")
                                            .value,
                                    ) || 1,
                                floor:
                                    parseInt(
                                        document.getElementById("propFloor")
                                            .value,
                                    ) || 1,
                                area:
                                    parseInt(
                                        document.getElementById("propArea")
                                            .value,
                                    ) || 800,
                            };

                            const putRes = await fetch(
                                API + "/properties/" + id,
                                {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(body),
                                },
                            );

                            if (putRes.ok) {
                                showToast("æˆ¿æºå·²æ›´æ–°");
                                closeModal();
                                loadProperties();
                            } else {
                                showToast("æ›´æ–°å¤±æ•—");
                            }
                        };

                    openModal();
                } catch (e) {
                    showToast("è¼‰å…¥å¤±æ•—");
                }
            }

            function handleFabClick() {
                haptic();
                if (currentPage === "orders") {
                    showOrderModal();
                } else {
                    showPropertyModal();
                }
            }

            function showOrderModal() {
                document.getElementById("modalTitle").textContent =
                    "ç™¼å¸ƒæ–°æ¸…æ½”ä»»å‹™";
                document.getElementById("modalBody").innerHTML = `
                <div class="form-group">
                    <label class="form-label">é¸æ“‡æˆ¿æº</label>
                    <select class="input-premium" id="orderPropId"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">é€€æˆ¿æ™‚é–“</label>
                    <input type="datetime-local" class="input-premium" id="orderTime">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¸…æ½”å ±åƒ¹ (TWD)</label>
                    <input type="number" class="input-premium" id="orderPrice" placeholder="1200">
                </div>
                <div class="form-group">
                    <label class="form-label">èªéŸ³å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
                    <div class="voice-record">
                        <button type="button" class="record-btn" id="recordBtn" onmousedown="event.preventDefault();startRecord('new')" onmouseup="event.preventDefault();stopRecord('new')" ontouchstart="event.preventDefault();startRecord('new')" ontouchend="event.preventDefault();stopRecord('new')">ğŸ¤</button>
                        <span class="record-hint" id="recordHint">æŒ‰ä½èªªè©±</span>
                        <div class="audio-preview" id="audioPreview" style="display:none">
                            <audio id="audioPreviewPlayer" controls></audio>
                            <button type="button" class="del-audio" onclick="deleteAudio()">åˆªé™¤</button>
                        </div>
                        <div class="voice-preview-box" id="preview-new" style="display:none; margin-top:10px;">
                            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">ğŸ”Š é è¦½éŒ„éŸ³ï¼š</div>
                            <audio controls id="previewAudio-new" style="width:100%;"></audio>
                            <div style="display:flex;gap:8px;margin-top:8px;">
                                <button class="voice-save-btn" onclick="saveVoice('new')" style="flex:1;padding:12px;border-radius:10px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;">âœ… ç¢ºèªä¿å­˜</button>
                                <button class="voice-cancel-btn" onclick="cancelVoice('new')" style="padding:12px;border-radius:10px;border:1px solid #ddd;background:white;color:#666;font-weight:700;cursor:pointer;">âœ• å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="orderVoice">
                </div>
            `;

                // åˆå§‹åŒ–éŒ„éŸ³
                initRecorder();

                // å¡«å……æˆ¿æºä¸‹æ‹‰èœå–®
                fetch(API + "/properties")
                    .then((r) => r.json())
                    .then((d) => {
                        const props = d.data || [];
                        document.getElementById("orderPropId").innerHTML = props
                            .map(
                                (p) =>
                                    `<option value="${p.id}">${p.name}</option>`,
                            )
                            .join("");
                    });

                document.getElementById("modalSubmit").onclick = async () => {
                    const body = {
                        property_id: parseInt(
                            document.getElementById("orderPropId").value,
                        ),
                        checkout_time:
                            document.getElementById("orderTime").value,
                        price: parseInt(
                            document.getElementById("orderPrice").value,
                        ),
                        host_phone: hostPhone,
                        status: "open",
                        voice_url:
                            document.getElementById("orderVoice").value || null,
                    };
                    const res = await fetch(`${API}/orders`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });
                    if (res.ok) {
                        showToast("ä»»å‹™å·²ç™¼å¸ƒï¼");
                        closeModal();
                        loadOrders();
                    }
                };
                openModal();
            }

            function showPropertyModal() {
                document.getElementById("modalTitle").textContent =
                    "æ–°å¢æˆ¿æºè³‡è¨Š";
                document.getElementById("modalBody").innerHTML = `
                <div class="form-group">
                    <label class="form-label">æˆ¿æºåç¨±</label>
                    <input type="text" class="input-premium" id="propName" placeholder="ä¾‹å¦‚ï¼šä¿¡ç¾©å€æ™¯è§€å¥—æˆ¿">
                </div>
                <div class="form-group">
                    <label class="form-label">å®Œæ•´åœ°å€</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" class="input-premium" id="propAddr" placeholder="è«‹è¼¸å…¥è©³ç´°åœ°å€" style="flex:1;">
                        <button type="button" onclick="verifyAddress()" style="padding:0 16px; border-radius:16px; border:none; background:var(--primary); color:white; font-weight:700; white-space:nowrap;">é©—è­‰</button>
                    </div>
                    <div id="addrStatus" style="font-size:12px; margin-top:6px; font-weight:600;"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
                    <div class="form-group">
                        <label class="form-label">çœ/å·</label>
                        <input type="text" class="input-premium" id="propProvince" placeholder="ä¾‹å¦‚ï¼šè‡ºåŒ—å¸‚">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¸‚/å€</label>
                        <input type="text" class="input-premium" id="propCity" placeholder="ä¾‹å¦‚ï¼šä¿¡ç¾©å€">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:12px">
                    <div class="form-group">
                        <label class="form-label">è¡—é“</label>
                        <input type="text" class="input-premium" id="propStreet" placeholder="ä¾‹å¦‚ï¼šå¿ å­æ±è·¯">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é–€ç‰Œ</label>
                        <input type="text" class="input-premium" id="propHouseNum" placeholder="ä¾‹å¦‚ï¼š123">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
                  <div class="form-group">
                      <label class="form-label">éƒµéå€è™Ÿ</label>
                      <input type="text" class="input-premium" id="propPostal" placeholder="ä¾‹å¦‚ï¼š110">
                  </div>
                  <div class="form-group">
                      <label class="form-label">é¢ç© (sqft)</label>
                      <input type="number" class="input-premium" id="propArea" value="800">
                  </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px">
                    <div class="form-group">
                        <label class="form-label">è‡¥å®¤</label>
                        <input type="number" class="input-premium" id="propBed" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¡›æµ´</label>
                        <input type="number" class="input-premium" id="propBath" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨“å±¤</label>
                        <input type="number" class="input-premium" id="propFloor" value="1">
                    </div>
                </div>

            `;
                document.getElementById("modalSubmit").onclick = async () => {
                    const name = document
                        .getElementById("propName")
                        .value.trim();
                    const address = document
                        .getElementById("propAddr")
                        .value.trim();
                    if (!name) {
                        showToast("è«‹è¼¸å…¥æˆ¿æºåç¨±");
                        return;
                    }
                    if (!address) {
                        showToast("è«‹è¼¸å…¥åœ°å€");
                        return;
                    }

                    const btn = document.getElementById("modalSubmit");
                    btn.disabled = true;
                    btn.textContent = "æäº¤ä¸­...";

                    const body = {
                        name: name,
                        address: address,
                        province: document
                            .getElementById("propProvince")
                            .value.trim(),
                        city: document.getElementById("propCity").value.trim(),
                        street: document
                            .getElementById("propStreet")
                            .value.trim(),
                        house_number: document
                            .getElementById("propHouseNum")
                            .value.trim(),
                        postal_code: document
                            .getElementById("propPostal")
                            .value.trim(),
                        bedrooms:
                            parseInt(
                                document.getElementById("propBed").value,
                            ) || 1,
                        bathrooms:
                            parseInt(
                                document.getElementById("propBath").value,
                            ) || 1,
                        floor:
                            parseInt(
                                document.getElementById("propFloor").value,
                            ) || 1,
                        area:
                            parseInt(
                                document.getElementById("propArea").value,
                            ) || 800,
                        host_phone: hostPhone,
                    };
                    const res = await fetch(`${API}/properties`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });
                    if (res.ok) {
                        showToast("æˆ¿æºå·²æ·»åŠ ");
                        closeModal();
                        loadProperties();
                    } else {
                        const err = await res.json();
                        showToast(err.error || "æ·»åŠ å¤±æ•—");
                        btn.disabled = false;
                        btn.textContent = "ç¢ºèªæäº¤";
                    }
                };
                openModal();
            }

            async function verifyAddress() {
                const addr = document.getElementById("propAddr").value.trim();
                const status = document.getElementById("addrStatus");
                if (!addr) {
                    showToast("è«‹å…ˆè¼¸å…¥åœ°å€");
                    return;
                }

                status.textContent = "ğŸ”„ é©—è­‰ä¸­...";
                status.style.color = "var(--text-muted)";

                try {
                    const res = await fetch(
                        `${API}/geocode?address=${encodeURIComponent(addr)}`,
                    );
                    const data = await res.json();
                    if (data.success) {
                        status.textContent = "âœ… åœ°å€é©—è­‰æˆåŠŸ";
                        status.style.color = "oklch(70% 0.18 150)";

                        // è‡ªå‹•å¡«å……çœã€å¸‚ã€è¡—é“ã€é–€ç‰Œã€éƒµéå€è™Ÿ
                        if (data.province)
                            document.getElementById("propProvince").value =
                                data.province;
                        if (data.city)
                            document.getElementById("propCity").value =
                                data.city;
                        if (data.street)
                            document.getElementById("propStreet").value =
                                data.street;
                        if (data.house_number)
                            document.getElementById("propHouseNum").value =
                                data.house_number;
                        if (data.postcode)
                            document.getElementById("propPostal").value =
                                data.postcode;
                    } else {
                        status.textContent =
                            "âŒ " + (data.error || "åœ°å€ç„¡æ³•è­˜åˆ¥");
                        status.style.color = "oklch(55% 0.18 25)";
                    }
                } catch (e) {
                    status.textContent = "âš ï¸ é©—è­‰å¤±æ•—ï¼Œè«‹é‡è©¦";
                    status.style.color = "oklch(55% 0.18 25)";
                }
            }

            async function deleteOrder(id) {
                if (!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿ")) return;
                await fetch(`${API}/orders/${id}`, { method: "DELETE" });
                showToast("å·²å–æ¶ˆè¨‚å–®");
                loadOrders();
            }

            async function editOrder(id) {
                try {
                    const res = await fetch(API + "/orders");
                    const data = await res.json();
                    const order = (data.data || []).find((o) => o.id === id);
                    if (!order) {
                        showToast("è¨‚å–®ä¸å­˜åœ¨");
                        return;
                    }

                    // ç²å–æˆ¿æºåˆ—è¡¨
                    const propsRes = await fetch(API + "/properties");
                    const propsData = await propsRes.json();
                    const properties = propsData.data || [];

                    document.getElementById("modalTitle").textContent =
                        "ä¿®æ”¹è¨‚å–®";
                    document.getElementById("modalBody").innerHTML = `
                    <div class="form-group">
                        <label class="form-label">é¸æ“‡æˆ¿æº</label>
                        <select class="input-premium" id="orderPropId"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é€€æˆ¿æ™‚é–“</label>
                        <input type="datetime-local" class="input-premium" id="orderTime" value="${order.checkout_time || ""}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¸…æ½”å ±åƒ¹ (TWD)</label>
                        <input type="number" class="input-premium" id="orderPrice" value="${order.price || 100}">
                    </div>
                `;

                    // å¡«å……æˆ¿æºä¸‹æ‹‰èœå–®ä¸¦é¸ä¸­ç•¶å‰
                    const propSelect = document.getElementById("orderPropId");
                    propSelect.innerHTML = properties
                        .map(
                            (p) =>
                                `<option value="${p.id}" ${p.id === order.property_id ? "selected" : ""}>${p.name}</option>`,
                        )
                        .join("");

                    document.getElementById("modalSubmit").onclick =
                        async () => {
                            const body = {
                                property_id: parseInt(
                                    document.getElementById("orderPropId")
                                        .value,
                                ),
                                checkout_time:
                                    document.getElementById("orderTime").value,
                                price: parseInt(
                                    document.getElementById("orderPrice").value,
                                ),
                            };

                            const putRes = await fetch(API + "/orders/" + id, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(body),
                            });

                            if (putRes.ok) {
                                showToast("è¨‚å–®å·²æ›´æ–°");
                                closeModal();
                                loadOrders();
                            } else {
                                showToast("æ›´æ–°å¤±æ•—");
                            }
                        };

                    openModal();
                } catch (e) {
                    showToast("è¼‰å…¥å¤±æ•—");
                }
            }

            function translateStatus(s, acceptedByHost) {
                if (s === 'completed' && acceptedByHost) return "å·²é©—æ”¶";
                return (
                    {
                        open: "å¾…æ¥å–®",
                        accepted: "å·¥ä½œä¸­",
                        completed: "å¾…é©—æ”¶",
                        accepted_by_host: "å·²é©—æ”¶",
                    }[s] || s
                );
            }

            function renderHostCompletionPhotos(
                photosJson,
                orderId,
                acceptedByHost,
            ) {
                if (!photosJson)
                    return '<div style="color:#999;font-size:13px;">æš«ç„¡ç…§ç‰‡</div>';
                try {
                    const photos =
                        typeof photosJson === "string"
                            ? JSON.parse(photosJson)
                            : photosJson;
                    if (!photos || photos.length === 0)
                        return '<div style="color:#999;font-size:13px;">æš«ç„¡ç…§ç‰‡</div>';
                    const accepted = acceptedByHost === 1;
                    return `
                    <div style="display:flex;gap:6px;overflow-x:auto;padding:8px 0;">
                        ${photos.map((p) => `<img src="${p}" style="width:60px;height:60px;border-radius:8px;object-fit:cover;flex-shrink:0;" onclick="viewPhoto('${p}')">`).join("")}
                    </div>
                    ${
                        accepted
                            ? `
                        <div style="padding:12px;background:#E8F5E9;border-radius:12px;text-align:center;color:#2E7D32;font-weight:700;">
                            âœ… å·²é©—æ”¶
                        </div>
                    `
                            : `
                        <button class="btn-accept" onclick="acceptCompletion(${orderId})" style="width:100%;padding:14px;margin-top:8px;border-radius:14px;border:none;background:var(--primary);color:white;font-weight:700;font-size:15px;cursor:pointer;">
                            âœ… é©—æ”¶å®Œæˆ
                        </button>
                    `
                    }
                `;
                } catch (e) {
                    return '<div style="color:#999;">è¼‰å…¥å¤±æ•—</div>';
                }
            }

            async function acceptCompletion(orderId) {
                if (!confirm("ç¢ºèªé©—æ”¶æ­¤è¨‚å–®ï¼Ÿ")) return;
                try {
                    const res = await fetch(`${API}/orders/${orderId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ status: "accepted", accepted_by_host: 1 }),
                    });
                    if (res.ok) {
                        showToast("âœ… é©—æ”¶æˆåŠŸï¼");
                        loadOrders();
                    } else {
                        showToast("é©—æ”¶å¤±æ•—");
                    }
                } catch (e) {
                    showToast("é©—æ”¶å¤±æ•—");
                }
            }

            function viewPhoto(url) {
                window.open(url, "_blank");
            }

            let currentViewOrderId = null;

            function viewOrderPhotos(orderId, photosJson, acceptedByHost) {
                console.log(
                    "viewOrderPhotos:",
                    orderId,
                    photosJson,
                    acceptedByHost,
                );
                currentViewOrderId = orderId;
                let photos = [];
                try {
                    // Handle both string and object
                    if (!photosJson) {
                        photos = [];
                    } else if (typeof photosJson === "string") {
                        const decoded = decodeURIComponent(photosJson);
                        const parsed = JSON.parse(decoded);
                        photos =
                            typeof parsed === "string"
                                ? JSON.parse(parsed)
                                : parsed;
                    } else if (Array.isArray(photosJson)) {
                        photos = photosJson;
                    } else if (typeof photosJson === "object") {
                        // Already parsed
                        photos = Object.values(photosJson);
                    }
                } catch (e) {
                    console.error("Parse photos error:", e);
                    photos = [];
                }

                console.log("Parsed photos:", photos);

                // Filter empty
                if (photos && Array.isArray(photos)) {
                    photos = photos.filter((p) => p && p.length > 0);
                }

                const content = document.getElementById("photoGalleryContent");
                const actions = document.getElementById("photoGalleryActions");

                if (!photos || !Array.isArray(photos) || photos.length === 0) {
                    content.innerHTML =
                        '<div style="color:white;text-align:center;padding:40px;">æš«ç„¡ç…§ç‰‡</div>';
                } else {
                    content.innerHTML = `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                    ${photos.map((p) => `<img src="${p}" style="width:100%;border-radius:12px;cursor:pointer;" onclick="viewPhoto('${p}')">`).join("")}
                </div>`;
                }

                if (acceptedByHost === 1) {
                    actions.innerHTML = `<div style="padding:16px;background:#E8F5E9;border-radius:16px;text-align:center;color:#2E7D32;font-weight:700;font-size:16px;">âœ… å·²é©—æ”¶</div>`;
                } else {
                    actions.innerHTML = `<button onclick="acceptCompletion(${orderId});closePhotoGallery();" style="width:100%;padding:18px;border-radius:16px;border:none;background:var(--primary);color:white;font-weight:700;font-size:16px;cursor:pointer;">âœ… é©—æ”¶å®Œæˆ</button>`;
                }

                document
                    .getElementById("photoGalleryModal")
                    .classList.add("active");
            }

            function closePhotoGallery() {
                document
                    .getElementById("photoGalleryModal")
                    .classList.remove("active");
                currentViewOrderId = null;
            }

            function openModal() {
                document.getElementById("globalModal").classList.add("active");
            }
            function closeModal() {
                document
                    .getElementById("globalModal")
                    .classList.remove("active");
            }

            function showToast(msg) {
                const t = document.getElementById("toast");
                t.textContent = msg;
                t.classList.add("show");
                setTimeout(() => t.classList.remove("show"), 2500);
            }

            async function submitProperty() {
                const name = document.getElementById("propName").value.trim();
                const address = document
                    .getElementById("propAddr")
                    .value.trim();
                if (!name) {
                    showToast("è«‹è¼¸å…¥æˆ¿æºåç¨±");
                    return;
                }
                if (!address) {
                    showToast("è«‹è¼¸å…¥åœ°å€");
                    return;
                }
                const btn = document.getElementById("modalSubmit");
                btn.disabled = true;
                btn.textContent = "æäº¤ä¸­...";
                const res = await fetch(API + "/properties", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name: name,
                        address: address,
                        bedrooms:
                            parseInt(
                                document.getElementById("propBed").value,
                            ) || 1,
                        bathrooms:
                            parseInt(
                                document.getElementById("propBath").value,
                            ) || 1,
                        floor:
                            parseInt(
                                document.getElementById("propFloor").value,
                            ) || 1,
                        area:
                            parseInt(
                                document.getElementById("propArea").value,
                            ) || 800,
                        host_phone: hostPhone,
                    }),
                });
                if (res.ok) {
                    showToast("æˆ¿æºå·²æ·»åŠ ");
                    closeModal();
                    loadProperties();
                } else {
                    const err = await res.json();
                    showToast(err.error || "æ·»åŠ å¤±æ•—");
                    btn.disabled = false;
                    btn.textContent = "ç¢ºèªæäº¤";
                }
            }

            // å½•éŸ³åŠŸèƒ½å˜é‡
            let mediaRecorder = null;
            let audioChunks = [];
            let currentRecordOrderId = null;
            let recordTimeout = null;
            let isRecording = false;

            async function initRecorder() {
                // å¦‚æœå·²ç¶“åˆå§‹åŒ–éï¼Œç›´æ¥è¿”å›
                if (mediaRecorder) return;

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: true,
                    });
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: "audio/webm",
                    });

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data && event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        console.log("éŒ„éŸ³åœæ­¢, chunks:", audioChunks.length);
                        const targetOrderId = currentRecordOrderId;
                        currentRecordOrderId = null;

                        if (audioChunks.length === 0) {
                            const btnId = targetOrderId === 'new' ? 'recordBtn' : `recordBtn-${targetOrderId}`;
                            const btn = document.getElementById(btnId);
                            if (btn) {
                                btn.textContent = "ğŸ¤ æŒ‰ä½éŒ„éŸ³ï¼ˆæœ€é•·20ç§’ï¼‰";
                                btn.disabled = false;
                            }
                            return;
                        }

                        const audioBlob = new Blob(audioChunks, {
                            type: "audio/webm",
                        });
                        audioChunks = [];

                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64 = reader.result;
                            console.log("éŸ³é »é•·åº¦:", base64.length);
                            if (targetOrderId && base64) {
                                // é¡¯ç¤ºé è¦½
                                showVoicePreview(targetOrderId, base64);
                            }
                        };
                        reader.readAsDataURL(audioBlob);
                    };

                    console.log("éº¥å…‹é¢¨å·²åˆå§‹åŒ–");
                } catch (e) {
                    console.error("éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•", e);
                    throw e;
                }
            }

            function startRecord(orderId) {
                // é˜²æ­¢é‡è¤‡è§¸ç™¼ï¼ˆmousedown + touchstart åŒæ™‚è§¸ç™¼ï¼‰
                if (isRecording) return;

                // å¦‚æœé‚„æ²’åˆå§‹åŒ–éº¥å…‹é¢¨ï¼Œå˜—è©¦åˆå§‹åŒ–
                if (!mediaRecorder) {
                    console.log("é¦–æ¬¡é»æ“Šï¼Œåˆå§‹åŒ–éº¥å…‹é¢¨...");
                    showToast("æ­£åœ¨è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™...");
                    initRecorder()
                        .then(() => {
                            if (!mediaRecorder) {
                                showToast("ç„¡æ³•è¨ªå•éº¥å…‹é¢¨ï¼Œè«‹å…è¨±æ¬Šé™");
                                isRecording = false;
                                return;
                            }
                            console.log("éº¥å…‹é¢¨åˆå§‹åŒ–æˆåŠŸï¼Œé–‹å§‹éŒ„éŸ³");
                            doStartRecord(orderId);
                        })
                        .catch((e) => {
                            showToast("ç„¡æ³•è¨ªå•éº¥å…‹é¢¨");
                            isRecording = false;
                        });
                    return;
                }

                doStartRecord(orderId);
            }

            function doStartRecord(orderId) {
                isRecording = true;
                currentRecordOrderId = orderId;
                // æ–°è¨‚å–®éŒ„éŸ³ä½¿ç”¨ recordBtnï¼Œå·²æœ‰è¨‚å–®ä½¿ç”¨ recordBtn-{id}
                const btnId = orderId === 'new' ? 'recordBtn' : `recordBtn-${orderId}`;
                const btn = document.getElementById(btnId);

                if (!btn) {
                    isRecording = false;
                    return;
                }

                audioChunks = [];
                try {
                    // æ¯100msæ”¶é›†ä¸€æ¬¡æ•¸æ“š
                    mediaRecorder.start(100);
                    console.log("é–‹å§‹éŒ„éŸ³");
                } catch (e) {
                    console.error("éŒ„éŸ³å¤±æ•—:", e);
                    showToast("éŒ„éŸ³å¤±æ•—: " + e.message);
                    isRecording = false;
                    btn.textContent = "ğŸ¤ æŒ‰ä½éŒ„éŸ³ï¼ˆæœ€é•·20ç§’ï¼‰";
                    btn.disabled = false;
                    return;
                }
                btn.classList.add("recording");
                btn.textContent = "ğŸ”´ éŒ„éŸ³ä¸­...";

                // 20ç§’è‡ªå‹•åœæ­¢
                recordTimeout = setTimeout(() => {
                    stopRecord(orderId);
                }, 20000);
            }

            function stopRecord(orderId) {
                if (!isRecording) return;
                isRecording = false;

                // æ¸…é™¤è¨ˆæ™‚å™¨
                if (recordTimeout) {
                    clearTimeout(recordTimeout);
                    recordTimeout = null;
                }

                const btn = document.getElementById(orderId === 'new' ? 'recordBtn' : `recordBtn-${orderId}`);
                if (btn) {
                    btn.classList.remove("recording");
                    btn.textContent = "â³ è™•ç†ä¸­...";
                    btn.disabled = true;
                }

                console.log("åœæ­¢éŒ„éŸ³, ç•¶å‰ç‹€æ…‹:", mediaRecorder?.state);

                // ä¿å­˜orderIdä¾›onstopå›èª¿ä½¿ç”¨
                const targetOrderId = currentRecordOrderId;

                if (mediaRecorder && mediaRecorder.state === "recording") {
                    try {
                        // è«‹æ±‚æœ€å¾Œçš„æ•¸æ“š
                        mediaRecorder.requestData();
                        mediaRecorder.stop();
                    } catch (e) {
                        console.error("åœæ­¢éŒ„éŸ³å¤±æ•—:", e);
                        // å¦‚æœåœæ­¢å¤±æ•—ï¼Œæ‰‹å‹•è™•ç†
                        if (btn) {
                            btn.textContent = "ğŸ¤ æŒ‰ä½éŒ„éŸ³ï¼ˆæœ€é•·20ç§’ï¼‰";
                            btn.disabled = false;
                        }
                    }
                } else {
                    // å¦‚æœæ²’æœ‰åœ¨éŒ„éŸ³
                    if (btn) {
                        btn.textContent = "ğŸ¤ æŒ‰ä½éŒ„éŸ³ï¼ˆæœ€é•·20ç§’ï¼‰";
                        btn.disabled = false;
                    }
                }
            }

            async function updateOrderVoice(orderId, voiceBase64) {
                console.log(
                    "æ›´æ–°è¨‚å–®èªéŸ³, orderId:",
                    orderId,
                    "length:",
                    voiceBase64?.length,
                );
                if (!voiceBase64 || voiceBase64.length < 100) {
                    showToast("éŒ„éŸ³ç„¡æ•ˆï¼Œè«‹é‡è©¦");
                    resetButton(orderId);
                    return;
                }
                try {
                    const res = await fetch(`${API}/orders/${orderId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ voice_url: voiceBase64 }),
                    });
                    console.log("APIéŸ¿æ‡‰:", res.status);
                    if (res.ok) {
                        showToast("ğŸ¤ èªéŸ³å‚™è¨»å·²ä¿å­˜");
                        loadOrders();
                    } else {
                        const err = await res.json();
                        console.error("ä¿å­˜å¤±æ•—:", err);
                        showToast("ä¿å­˜å¤±æ•—: " + (err.error || ""));
                        resetButton(orderId);
                    }
                } catch (e) {
                    console.error("ä¿å­˜å¤±æ•—:", e);
                    showToast("ä¿å­˜å¤±æ•—");
                    resetButton(orderId);
                }
            }

            function resetButton(orderId) {
                const btn = document.getElementById(orderId === 'new' ? 'recordBtn' : `recordBtn-${orderId}`);
                if (btn) {
                    btn.textContent = "ğŸ¤ æŒ‰ä½éŒ„éŸ³ï¼ˆæœ€é•·20ç§’ï¼‰";
                    btn.disabled = false;
                }
            }

            // åˆªé™¤æ–°è¨‚å–®çš„éŒ„éŸ³
            function deleteAudio() {
                const voiceInput = document.getElementById('orderVoice');
                if (voiceInput) voiceInput.value = '';
                const audioPreview = document.getElementById('audioPreview');
                const preview = document.getElementById('preview-new');
                const btn = document.getElementById('recordBtn');
                if (audioPreview) audioPreview.style.display = 'none';
                if (preview) preview.style.display = 'none';
                if (btn) {
                    btn.style.display = 'block';
                    btn.textContent = 'ğŸ¤ æŒ‰ä½èªªè©±';
                }
                delete pendingVoiceData['new'];
            }

            // é¡¯ç¤ºéŒ„éŸ³é è¦½
            let pendingVoiceData = {};

            function showVoicePreview(orderId, base64) {
                const btn = document.getElementById(orderId === 'new' ? 'recordBtn' : `recordBtn-${orderId}`);
                const preview = document.getElementById(`preview-${orderId}`);
                const previewAudio = document.getElementById(
                    `previewAudio-${orderId}`,
                );

                if (btn) btn.style.display = "none";
                if (preview) {
                    preview.style.display = "block";
                    previewAudio.src = base64;
                }

                // ä¿å­˜å¾…æäº¤çš„éŸ³é »æ•¸æ“š
                pendingVoiceData[orderId] = base64;
            }

            // ç¢ºèªä¿å­˜éŒ„éŸ³
            async function saveVoice(orderId) {
                const base64 = pendingVoiceData[orderId];
                if (!base64) {
                    showToast("æ²’æœ‰éŒ„éŸ³æ•¸æ“š");
                    return;
                }

                console.log("saveVoice called, orderId:", orderId, "base64 length:", base64.length);

                // æ–°è¨‚å–®ï¼šä¿å­˜åˆ°è¡¨å–®è¼¸å…¥æ¡†
                if (orderId === 'new') {
                    const voiceInput = document.getElementById('orderVoice');
                    if (voiceInput) voiceInput.value = base64;
                    
                    // é¡¯ç¤ºé è¦½
                    const preview = document.getElementById('preview-new');
                    const previewPlayer = document.getElementById('audioPreviewPlayer');
                    if (preview) preview.style.display = 'none';
                    const audioPreview = document.getElementById('audioPreview');
                    if (audioPreview) {
                        audioPreview.style.display = 'flex';
                        previewPlayer.src = base64;
                    }
                    
                    showToast('ğŸ¤ èªéŸ³å‚™è¨»å·²ä¿å­˜');
                    delete pendingVoiceData[orderId];
                    return;
                }

                // å·²æœ‰è¨‚å–®ï¼šèª¿ç”¨ API æ›´æ–°
                try {
                    const res = await fetch(`${API}/orders/${orderId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ voice_url: base64 }),
                    });
                    console.log("Response status:", res.status);
                    const result = await res.json();
                    console.log("Response:", result);

                    if (res.ok) {
                        showToast("ğŸ¤ èªéŸ³å‚™è¨»å·²ä¿å­˜");
                        delete pendingVoiceData[orderId];
                        loadOrders();
                    } else {
                        showToast("ä¿å­˜å¤±æ•—: " + (result.error || ""));
                    }
                } catch (e) {
                    console.error("ä¿å­˜å¤±æ•—:", e);
                    showToast("ä¿å­˜å¤±æ•—");
                }
            }

            // å–æ¶ˆéŒ„éŸ³
            function cancelVoice(orderId) {
                delete pendingVoiceData[orderId];

                const btn = document.getElementById(orderId === 'new' ? 'recordBtn' : `recordBtn-${orderId}`);
                const preview = document.getElementById(`preview-${orderId}`);

                if (preview) preview.style.display = "none";
                if (btn) {
                    btn.style.display = "block";
                    btn.textContent = "ğŸ¤ æŒ‰ä½éŒ„éŸ³ï¼ˆæœ€é•·20ç§’ï¼‰";
                    btn.disabled = false;
                }
            }

            async function deleteVoice(orderId) {
                if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™æ®µèªéŸ³å‚™è¨»å—ï¼Ÿ")) return;
                try {
                    const res = await fetch(`${API}/orders/${orderId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ voice_url: null }),
                    });
                    if (res.ok) {
                        showToast("èªéŸ³å·²åˆªé™¤");
                        loadOrders();
                    } else {
                        showToast("åˆªé™¤å¤±æ•—");
                    }
                } catch (e) {
                    showToast("åˆªé™¤å¤±æ•—");
                }
            }

            // åˆå§‹åŒ–
            loadOrders();
            initRecorder();
        </script>
    </body>
</html>
