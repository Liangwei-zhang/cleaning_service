<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘· çŸ­ç§Ÿæ¸…æ½” - æ¥å–®å“¡</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        header { background: #2E7D32; border: 1px solid #1B5E20; padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 18px; }
        .logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        
        /* å¯¼èˆªæ  */
        .nav { display: flex; background: white; padding: 10px 15px; gap: 10px; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; background: #f0f0f0; color: #333; }
        .nav-btn.active { background: #2E7D32; border: 1px solid #1B5E20; color: white; }
        
        .content { padding: 15px; animation: fadeIn 1.5s ease; }
        .btn { background: #2E7D32; border: 1px solid #1B5E20; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn-success { background: #43a047; color: white; border: 1px solid #388E3C; padding: 10px 18px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        
        .card-actions { display: flex; justify-content: flex-end; margin-top: 10px; }
        
        .card { background: white; padding: 15px; border-radius: 4px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-title { font-weight: bold; font-size: 16px; }
        .card-info { color: #666; font-size: 13px; margin-top: 5px; }
        .price { color: #2E7D32; font-weight: bold; font-size: 18px; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .badge.open { background: #388E3C; color: white; }
        .badge.accepted { background: #1976D2; color: white; }
        .badge.completed { background: #9E9E9E; color: white; }
        
        .empty { text-align: center; padding: 30px; color: #999; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 4px; padding: 24px; width: 90%; max-width: 360px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 8px; color: #333; }
        .modal-desc { text-align: center; color: #666; font-size: 14px; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 4px; font-size: 18px; text-align: center; letter-spacing: 4px; margin-bottom: 20px; outline: none; transition: border-color 0.2s; }
        .modal-input:focus { border-color: #2E7D32; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 4px; font-size: 15px; cursor: pointer; font-weight: 500; }
        .modal-btn.cancel { background: #f0f0f0; color: #666; }
        .modal-btn.confirm { background: #2E7D32; border: 1px solid #1B5E20; color: white; }
        .modal-btn.confirm:hover { background: #7a8a4c; }
        
        /* å®Œæˆç¡®è®¤æ¨¡æ€æ¡† */
        .modal-success .modal-title { color: #388E3C; }
        
        /* Toast æç¤º */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: white; padding: 14px 24px; border-radius: 4px; font-size: 15px; z-index: 2000; opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #388E3C; }
        .toast.error { background: #f44336; }
        .toast.warn { background: #ff9800; }
    .fade-in { animation: fadeIn 1.5s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.card { animation: fadeIn 1.5s ease; }
</style>
</head>
<body>
    <header>
        <h1>ğŸ‘· çŸ­ç§Ÿæ¸…æ½” - æ¥å–®å“¡</h1>
        <button class="logout" onclick="logout()">ç™»å‡º</button>
    </header>
    
    <!-- å¯¼èˆª -->
    <div class="nav">
        <button class="nav-btn active" id="navOpen" onclick="showPage('open')">ğŸ“‹ æ¶å–®å¤§å»³</button>
        <button class="nav-btn" id="navHistory" onclick="showPage('history')">ğŸ“œ æˆ‘çš„æ­·å²</button>
    </div>
    
    <!-- æ¶å–®å¤§å»³ -->
    <div id="pageOpen" class="content">
        <div id="openOrders"></div>
    </div>
    
    <!-- æˆ‘çš„æ­·å² -->
    <div id="pageHistory" class="content" style="display:none">
        <div id="myHistory"></div>
    </div>
    
    <!-- é©—è­‰ç¢¼æ¨¡æ…‹æ¡† -->
    <div id="verifyModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">ğŸ” è¼¸å…¥é©—è­‰ç¢¼</div>
            <div class="modal-desc">è«‹è¼¸å…¥æˆ¿æ±æä¾›çš„é©—è­‰ç¢¼ç¢ºèªæ¥å–®</div>
            <input type="text" id="verifyCodeInput" class="modal-input" placeholder="000000" maxlength="6" inputmode="numeric" onkeypress="if(event.key==='Enter')confirmAccept()">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeVerifyModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmAccept()">ç¢ºèª</button>
            </div>
        </div>
    </div>
    
    <!-- å®Œæˆç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="completeModal" class="modal-overlay">
        <div class="modal modal-success">
            <div class="modal-title">âœ… ç¢ºèªå®Œæˆ</div>
            <div class="modal-desc">ç¢ºå®šå·²å®Œæˆæ¸…æ½”ä¸¦é›¢é–‹æˆ¿æºå—ï¼Ÿ</div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeCompleteModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmComplete()">ç¢ºèªå®Œæˆ</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const h = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${day} ${h}:${min}`;
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type;
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        const API = 'https://biggish-londyn-unconvolute.ngrok-free.dev/api';
        let cleanerId = localStorage.getItem('cleaner_id');
        
        if (!cleanerId) {
            showToast('è«‹å…ˆç™»éŒ„', 'warn');
            location.href = 'index.html';
        }
        
        function logout() {
            localStorage.clear();
            location.href = 'index.html';
        }
        
        // é¡µé¢åˆ‡æ¢
        function showPage(page) {
            document.getElementById('navOpen').className = page === 'open' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('navHistory').className = page === 'history' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('pageOpen').style.display = page === 'open' ? 'block' : 'none';
            document.getElementById('pageHistory').style.display = page === 'history' ? 'block' : 'none';
        }
        
        // åŠ è½½è®¢å•
        async function loadOrders() {
            const res = await fetch(API + '/orders');
            const data = await res.json();
            
            // æŠ¢å•å¤§å… - å¼€æ”¾è®¢å•
            const openOrders = data.data.filter(o => o.status === 'open');
            document.getElementById('openOrders').innerHTML = openOrders.map(o => `
                <div class="card">
                    <div class="card-title">${o.property_name || 'æœªçŸ¥æˆ¿æº'}</div>
                    <div class="card-info">${o.property_address || ''}</div>
                    <div class="card-info">ğŸ  ${o.host_name} | ğŸ“ ${o.host_phone}</div>
                    <div class="card-info">ğŸ• ${formatTime(o.checkout_time)} | <span class="price">$${o.price}</span></div>
                    <div class="card-actions"><button class="btn btn-success" onclick="acceptOrder(${o.id})">âœ‹ æˆ‘è¦æ¥å–®</button></div>
                </div>
            `).join('') || '<div class="empty">æš«ç„¡é–‹æ”¾è¨‚å–®</div>';
            
            // æˆ‘çš„å†å²
            const myHistory = data.data.filter(o => o.assigned_cleaner_id == cleanerId && o.status !== 'open');
            document.getElementById('myHistory').innerHTML = myHistory.map(o => `
                <div class="card">
                    <div class="card-title">${o.property_name || 'æœªçŸ¥æˆ¿æº'}</div>
                    <div class="card-info">ğŸ• ${formatTime(o.checkout_time)} | <span class="price">$${o.price}</span></div>
                    <div style="margin-top:8px"><span class="badge ${o.status}">${o.status === 'accepted' ? 'å·²æ¥å–®' : 'å·²å®Œæˆ'}</span></div>
                    ${o.status === 'accepted' ? `<div class="card-actions"><button class="btn btn-success" onclick="completeOrder(${o.id})">âœ… å®Œæˆæ¸…æ½”</button></div>` : ''}
                </div>
            `).join('') || '<div class="empty">æš«ç„¡æ­·å²è¨‚å–®</div>';
        }
        
        let pendingOrderId = null;
        
        function openVerifyModal(orderId) {
            pendingOrderId = orderId;
            document.getElementById('verifyCodeInput').value = '';
            document.getElementById('verifyModal').classList.add('show');
            document.getElementById('verifyCodeInput').focus();
        }
        
        function closeVerifyModal() {
            document.getElementById('verifyModal').classList.remove('show');
            pendingOrderId = null;
        }
        
        async function confirmAccept() {
            const code = document.getElementById('verifyCodeInput').value.trim();
            if (!code) {
                showToast('è«‹è¼¸å…¥é©—è­‰ç¢¼', 'warn');
                return;
            }
            
            const res = await fetch(API + '/orders/' + pendingOrderId + '/verify-accept', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cleaner_id: cleanerId, code: code })
            });
            
            closeVerifyModal();
            
            if (res.ok) {
                showToast('æ¥å–®æˆåŠŸï¼');
                loadOrders();
            } else {
                showToast('é©—è­‰ç¢¼éŒ¯èª¤', 'error');
            }
        }
        
        async function acceptOrder(orderId) {
            openVerifyModal(orderId);
        }
        
        let pendingCompleteId = null;
        
        function openCompleteModal(orderId) {
            pendingCompleteId = orderId;
            document.getElementById('completeModal').classList.add('show');
        }
        
        function closeCompleteModal() {
            document.getElementById('completeModal').classList.remove('show');
            pendingCompleteId = null;
        }
        
        async function confirmComplete() {
            await fetch(API + '/orders/' + pendingCompleteId + '?action=complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            closeCompleteModal();
            showToast('å·²å®Œæˆï¼');
            loadOrders();
        }
        
        async function completeOrder(orderId) {
            openCompleteModal(orderId);
        }
        
        loadOrders();
    </script>
</body>
</html>
