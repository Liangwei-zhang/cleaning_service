<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘· çŸ­ç§Ÿæ¸…æ½” - æ¥å–®å“¡</title>
    <style>$(cat /tmp/optimized.css)</style>
</head>
<body>
    <header>
        <h1>ğŸ‘· çŸ­ç§Ÿæ¸…æ½”</h1>
        <button class="logout" onclick="logout()">ç™»å‡º</button>
    </header>
    
    <nav class="nav">
        <button class="nav-btn active" id="navOrders" onclick="showPage('orders')">ğŸ“‹ æ¶å–®å¤§å»³</button>
        <button class="nav-btn" id="navHistory" onclick="showPage('history')">ğŸ“œ æˆ‘çš„æ­·å²</button>
    </nav>
    
    <div id="pageOrders" class="content">
        <div id="ordersList"></div>
    </div>
    
    <div id="pageHistory" class="content" style="display:none">
        <div id="myHistory"></div>
    </div>
    
    <!-- é©—è­‰ç¢¼ Modal -->
    <div class="modal" id="verifyModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ” è¼¸å…¥é©—è­‰ç¢¼</div>
            <div class="modal-desc">è«‹è¼¸å…¥æˆ¿æ±æä¾›çš„é©—è­‰ç¢¼ç¢ºèªæ¥å–®</div>
            <input type="text" id="verifyCodeInput" class="modal-input" placeholder="000000" maxlength="6" inputmode="numeric">
            <div class="modal-btns">
                <button class="btn" style="background:var(--bg-main);color:var(--text-p)" onclick="closeVerifyModal()">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="confirmAccept()">ç¢ºèª</button>
            </div>
        </div>
    </div>
    
    <!-- å®Œæˆç¢ºèª Modal -->
    <div class="modal" id="completeModal">
        <div class="modal-content">
            <div class="modal-title">âœ… ç¢ºèªå®Œæˆ</div>
            <div class="modal-desc">ç¢ºå®šå·²å®Œæˆæ¸…æ½”ä¸¦é›¢é–‹æˆ¿æºå—ï¼Ÿ</div>
            <div class="modal-btns">
                <button class="btn" style="background:var(--bg-main);color:var(--text-p)" onclick="closeCompleteModal()">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="confirmComplete()">ç¢ºèªå®Œæˆ</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        const API = 'http://127.0.0.1:80/api';
        
        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const h = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${day} ${h}:${min}`;
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.background = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--text-h)';
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => toast.classList.remove('show'), 2500);
            if (navigator.vibrate) navigator.vibrate(10);
        }
        
        const cleanerId = localStorage.getItem('cleaner_id');
        if (!cleanerId) {
            showToast('è«‹å…ˆç™»éŒ„', 'warn');
            location.href = 'index.html';
        }
        
        function showPage(page) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(page === 'orders' ? 'navOrders' : 'navHistory').classList.add('active');
            document.getElementById('pageOrders').style.display = page === 'orders' ? 'block' : 'none';
            document.getElementById('pageHistory').style.display = page === 'history' ? 'block' : 'none';
            if (page === 'orders') loadOrders();
            if (page === 'history') loadHistory();
        }
        
        function logout() {
            localStorage.clear();
            location.href = 'index.html';
        }
        
        async function loadOrders() {
            const res = await fetch(API + '/orders');
            const data = await res.json();
            const orders = data.data?.filter(o => o.status === 'open') || [];
            document.getElementById('ordersList').innerHTML = orders.map(o => `
                <div class="card">
                    <div class="card-title">${o.property_name || 'æœªçŸ¥æˆ¿æº'}</div>
                    <div class="card-info">${o.property_address || '-'}</div>
                    <div class="card-info">ğŸ• ${formatTime(o.checkout_time)} | <span class="price">$${o.price}</span></div>
                    <div class="card-actions"><button class="btn btn-success" onclick="acceptOrder(${o.id})">âœ‹ æˆ‘è¦æ¥å–®</button></div>
                </div>
            `).join('') || '<div class="empty">æš«ç„¡é–‹æ”¾è¨‚å–®</div>';
        }
        
        async function loadHistory() {
            const res = await fetch(API + '/orders');
            const data = await res.json();
            const myHistory = data.data?.filter(o => o.assigned_cleaner_id == cleanerId && o.status !== 'open') || [];
            document.getElementById('myHistory').innerHTML = myHistory.map(o => `
                <div class="card">
                    <div class="card-title">${o.property_name || 'æœªçŸ¥æˆ¿æº'}</div>
                    <div class="card-info">ğŸ• ${formatTime(o.checkout_time)} | <span class="price">$${o.price}</span></div>
                    <div style="margin-top:8px"><span class="badge ${o.status}">${o.status === 'accepted' ? 'å·²æ¥å–®' : 'å·²å®Œæˆ'}</span></div>
                    ${o.status === 'accepted' ? `<div class="card-actions"><button class="btn btn-success" onclick="completeOrder(${o.id})">âœ… å®Œæˆæ¸…æ½”</button></div>` : ''}
                </div>
            `).join('') || '<div class="empty">æš«ç„¡æ­·å²è¨‚å–®</div>';
        }
        
        let pendingOrderId = null;
        
        function openVerifyModal(orderId) {
            pendingOrderId = orderId;
            document.getElementById('verifyCodeInput').value = '';
            document.getElementById('verifyModal').classList.add('active');
            document.getElementById('verifyCodeInput').focus();
        }
        
        function closeVerifyModal() {
            document.getElementById('verifyModal').classList.remove('active');
            pendingOrderId = null;
        }
        
        async function confirmAccept() {
            const code = document.getElementById('verifyCodeInput').value.trim();
            if (!code) { showToast('è«‹è¼¸å…¥é©—è­‰ç¢¼', 'warn'); return; }
            
            const res = await fetch(API + '/orders/' + pendingOrderId + '/verify-accept', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cleaner_id: cleanerId, code: code })
            });
            
            closeVerifyModal();
            
            if (res.ok) {
                showToast('æ¥å–®æˆåŠŸï¼');
                loadOrders();
            } else {
                showToast('é©—è­‰ç¢¼éŒ¯èª¤', 'error');
            }
        }
        
        async function acceptOrder(orderId) {
            openVerifyModal(orderId);
        }
        
        let pendingCompleteId = null;
        
        function openCompleteModal(orderId) {
            pendingCompleteId = orderId;
            document.getElementById('completeModal').classList.add('active');
        }
        
        function closeCompleteModal() {
            document.getElementById('completeModal').classList.remove('active');
            pendingCompleteId = null;
        }
        
        async function confirmComplete() {
            await fetch(API + '/orders/' + pendingCompleteId + '?action=complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            closeCompleteModal();
            showToast('å·²å®Œæˆï¼');
            loadHistory();
        }
        
        async function completeOrder(orderId) {
            openCompleteModal(orderId);
        }
        
        loadOrders();
    </script>
</body>
</html>
