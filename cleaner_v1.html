<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘· çŸ­ç§Ÿæ¸…æ½” - æ¥å–®å“¡</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        header { background: #8A9A5B; padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 18px; }
        .logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        
        /* å¯¼èˆªæ  */
        .nav { display: flex; background: white; padding: 10px 15px; gap: 10px; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; background: #f0f0f0; color: #333; }
        .nav-btn.active { background: #8A9A5B; color: white; }
        
        .content { padding: 15px; }
        .btn { background: #8A9A5B; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn-success { background: #4CAF50; }
        
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-title { font-weight: bold; font-size: 16px; }
        .card-info { color: #666; font-size: 13px; margin-top: 5px; }
        .price { color: #8A9A5B; font-weight: bold; font-size: 18px; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .badge.open { background: #4CAF50; color: white; }
        .badge.accepted { background: #2196F3; color: white; }
        .badge.completed { background: #9E9E9E; color: white; }
        
        .empty { text-align: center; padding: 30px; color: #999; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ‘· çŸ­ç§Ÿæ¸…æ½” - æ¥å–®å“¡</h1>
        <button class="logout" onclick="logout()">ç™»å‡º</button>
    </header>
    
    <!-- å¯¼èˆª -->
    <div class="nav">
        <button class="nav-btn active" id="navOpen" onclick="showPage('open')">ğŸ“‹ æ¶å–®å¤§å»³</button>
        <button class="nav-btn" id="navHistory" onclick="showPage('history')">ğŸ“œ æˆ‘çš„æ­·å²</button>
    </div>
    
    <!-- æ¶å–®å¤§å»³ -->
    <div id="pageOpen" class="content">
        <div id="openOrders"></div>
    </div>
    
    <!-- æˆ‘çš„æ­·å² -->
    <div id="pageHistory" class="content" style="display:none">
        <div id="myHistory"></div>
    </div>
    
    <script>
        const API = 'http://127.0.0.1:5000/api';
        let cleanerId = localStorage.getItem('cleaner_id');
        
        if (!cleanerId) {
            alert('è«‹å…ˆç™»éŒ„');
            location.href = 'index.html';
        }
        
        function logout() {
            localStorage.clear();
            location.href = 'index.html';
        }
        
        // é¡µé¢åˆ‡æ¢
        function showPage(page) {
            document.getElementById('navOpen').className = page === 'open' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('navHistory').className = page === 'history' ? 'nav-btn active' : 'nav-btn';
            document.getElementById('pageOpen').style.display = page === 'open' ? 'block' : 'none';
            document.getElementById('pageHistory').style.display = page === 'history' ? 'block' : 'none';
        }
        
        // åŠ è½½è®¢å•
        async function loadOrders() {
            const res = await fetch(API + '/orders');
            const data = await res.json();
            
            // æŠ¢å•å¤§å… - å¼€æ”¾è®¢å•
            const openOrders = data.data.filter(o => o.status === 'open');
            document.getElementById('openOrders').innerHTML = openOrders.map(o => `
                <div class="card">
                    <div class="card-title">${o.property_name || 'æœªçŸ¥æˆ¿æº'}</div>
                    <div class="card-info">${o.property_address || ''}</div>
                    <div class="card-info">ğŸ  ${o.host_name} | ğŸ“ ${o.host_phone}</div>
                    <div class="card-info">ğŸ• ${o.checkout_time} | <span class="price">$${o.price}</span></div>
                    <button class="btn btn-success" onclick="acceptOrder(${o.id})">æ¥å–®</button>
                </div>
            `).join('') || '<div class="empty">æš«ç„¡é–‹æ”¾è¨‚å–®</div>';
            
            // æˆ‘çš„å†å²
            const myHistory = data.data.filter(o => o.assigned_cleaner_id == cleanerId && o.status !== 'open');
            document.getElementById('myHistory').innerHTML = myHistory.map(o => `
                <div class="card">
                    <div class="card-title">${o.property_name || 'æœªçŸ¥æˆ¿æº'}</div>
                    <div class="card-info">ğŸ• ${o.checkout_time} | <span class="price">$${o.price}</span></div>
                    <div style="margin-top:8px"><span class="badge ${o.status}">${o.status === 'accepted' ? 'å·²æ¥å–®' : 'å·²å®Œæˆ'}</span></div>
                    ${o.status === 'accepted' ? `<button class="btn" onclick="completeOrder(${o.id})">å®Œæˆæ¸…æ½”</button>` : ''}
                </div>
            `).join('') || '<div class="empty">æš«ç„¡æ­·å²è¨‚å–®</div>';
        }
        
        async function acceptOrder(orderId) {
            const code = prompt('è«‹è¼¸å…¥é©—è­‰ç¢¼:');
            if (!code) return;
            
            const res = await fetch(API + '/orders/' + orderId + '/verify-accept', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cleaner_id: cleanerId, code: code })
            });
            
            if (res.ok) {
                alert('æ¥å–®æˆåŠŸï¼');
                loadOrders();
            } else {
                alert('é©—è­‰ç¢¼éŒ¯èª¤');
            }
        }
        
        async function completeOrder(orderId) {
            await fetch(API + '/orders/' + orderId + '?action=complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            alert('å·²å®Œæˆï¼');
            loadOrders();
        }
        
        loadOrders();
    </script>
</body>
</html>
